<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>êµ¬ë‘í…ŒìŠ¤íŠ¸ í€´ì¦ˆ - í™•ë¥ ê³¼ í†µê³„</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="OXí€´ì¦ˆ">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  <style>
    * { 
      font-family: 'Noto Sans KR', sans-serif;
    }
    .icon { width: 24px; height: 24px; stroke: currentColor; fill: none; stroke-width: 2; }
    
    /* ìˆ˜ì‹ ë Œë”ë§ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ìˆ¨ê¹€ (SSRì²˜ëŸ¼ ë³´ì´ë„ë¡) */
    #app {
      opacity: 0;
      transition: opacity 0.15s ease-in;
    }

    #app.ready {
      opacity: 1;
    }
    
    @media (hover: none) and (pointer: coarse) {
      * {
        -webkit-tap-highlight-color: transparent;
        transition: none !important;
      }
      *:active, *:focus, *:hover {
        outline: none !important;
        border-color: inherit !important;
        box-shadow: inherit !important;
        transform: none !important;
      }
    }
  </style>
</head>
<body class="bg-black">
  <div id="app"></div>

  <script>
    // Firebase ì„¤ì • - í™•ë¥ ê³¼ í†µê³„ ì „ìš©
    const firebaseConfig = {
      apiKey: "YOUR_PROBABILITY_STATISTICS_API_KEY",
      authDomain: "probability-statistics-quiz.firebaseapp.com",
      projectId: "probability-statistics-quiz",
      storageBucket: "probability-statistics-quiz.firebasestorage.app",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_PROBABILITY_STATISTICS_APP_ID"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const storage = firebase.storage();

    let offlineDB;

    // ê´€ë¦¬ì ë³´ì•ˆ í‚¤ (ì‹¤ì œ ì‚¬ìš©ì‹œ í™˜ê²½ë³€ìˆ˜ë‚˜ ì•ˆì „í•œ ê³³ì— ë³´ê´€)
    const ADMIN_SECRET_KEY = "MATH2025ADMIN";
    const ADMIN_PASSWORD = "teacher2025"; // ê´€ë¦¬ì ê³µí†µ ë¹„ë°€ë²ˆí˜¸

    // í•™ìƒ ìƒíƒœ: 'active' (ì¬ì›ìƒ), 'withdrawn' (í‡´ì›ìƒ)
    
    // ì•„ì´ì½˜ SVG
    const icons = {
      user: '<path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2M16 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/>',
      bookOpen: '<path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2zM22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>',
      chevronLeft: '<path d="m15 18-6-6 6-6"/>',
      chevronRight: '<path d="m9 18 6-6-6-6"/>',
      home: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2zM9 22V12h6v10"/>',
      barChart: '<path d="M3 3v18h18M18 17V9M13 17V5M8 17v-3"/>',
      award: '<path d="M8.21 13.89 7 23l5-3 5 3-1.21-9.12M15 8A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>',
      lock: '<path d="M7 11V7a5 5 0 0 1 10 0v4M5 11h14a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2Z"/>',
      checkCircle: '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4 12 14.01l-3-3"/>',
      xCircle: '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/>',
      clock: '<path d="M12 6v6l4 2M22 12A10 10 0 1 1 2 12a10 10 0 0 1 20 0Z"/>',
      users: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75M13 7a4 4 0 1 1-8 0 4 4 0 0 1 8 0Z"/>',
      settings: '<circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m6.36 6.36 4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m6.36-6.36 4.24-4.24"/>',
      refreshCw: '<path d="M23 4v6h-6M1 20v-6h6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>',
      info: '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><circle cx="12" cy="8" r=".5"/>'
    };

    function icon(type, className = '', size = 24) {
      return `<svg class="${className}" style="width:${size}px;height:${size}px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${icons[type]}</svg>`;
    }

    // IndexedDB ì´ˆê¸°í™”
    function initIndexedDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('OXQuizDB', 1);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          offlineDB = request.result;
          resolve(offlineDB);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains('pendingData')) {
            db.createObjectStore('pendingData', { keyPath: 'id', autoIncrement: true });
          }
        };
      });
    }

    async function saveToIndexedDB(data) {
      return new Promise((resolve, reject) => {
        const transaction = offlineDB.transaction(['pendingData'], 'readwrite');
        const store = transaction.objectStore('pendingData');
        const request = store.add({
          uid: state.uid,
          data: data,
          timestamp: Date.now()
        });
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function deleteFromIndexedDB(id) {
      return new Promise((resolve, reject) => {
        const transaction = offlineDB.transaction(['pendingData'], 'readwrite');
        const store = transaction.objectStore('pendingData');
        const request = store.delete(id);
        
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
    }

    async function syncPendingData() {
      try {
        const transaction = offlineDB.transaction(['pendingData'], 'readonly');
        const store = transaction.objectStore('pendingData');
        const request = store.getAll();
        
        request.onsuccess = async () => {
          const pendingItems = request.result;
          
          for (const item of pendingItems) {
            try {
              await db.collection('oral-test-students').doc(item.uid).set(item.data);
              await deleteFromIndexedDB(item.id);
              console.log('ë™ê¸°í™” ì™„ë£Œ:', item.id);
            } catch (error) {
              console.error('ë™ê¸°í™” ì‹¤íŒ¨:', error);
            }
          }
          
          if (pendingItems.length > 0) {
            alert(`${pendingItems.length}ê°œì˜ ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            await loadData(state.uid);
            render();
          }
        };
      } catch (error) {
        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
      }
    }

    // ì¹´í…Œê³ ë¦¬ ë°ì´í„°
    const categories = [];

    // ìƒíƒœ ê´€ë¦¬
    const state = {
      userType: null, // 'student' or 'admin'
      studentName: '',
      phone: '',
      teacherName: '', // í•™ìƒì˜ ë‹´ë‹¹ ì„ ìƒë‹˜
      adminName: '', // ê´€ë¦¬ì ì´ë¦„
      isLoggedIn: false,
      uid: '',
      loading: false,
      selectedCategory: null,
      currentTheme: null,
      currentQuestion: 0,
      answers: {},
      allStudentData: {},
      showResults: false,
      lockTimers: {},
      currentTime: Date.now(),
      autoLogin: false,
      // ê´€ë¦¬ì ì „ìš©
      adminStudents: [], // ê´€ë¦¬ìê°€ ë‹´ë‹¹í•˜ëŠ” í•™ìƒ ëª©ë¡
      selectedStudent: null, // ê´€ë¦¬ìê°€ ì„ íƒí•œ í•™ìƒ
      showAdminRegister: false,
      studentStatusFilter: 'active', // 'active' (ì¬ì›ìƒ) ë˜ëŠ” 'withdrawn' (í‡´ì›ìƒ)
      showStudentRecords: false, // í•™ìƒ í•™ìŠµ ê¸°ë¡ ë³´ê¸° ëª¨ë“œ
      // í•™ìŠµ ê¸°ë¡ ì „ìš©
      recordSelectedCategory: null, // í•™ìŠµ ê¸°ë¡ì—ì„œ ì„ íƒí•œ ì¹´í…Œê³ ë¦¬
      expandedAttempts: {}, // í™•ì¥ëœ ì‹œë„ ëª©ë¡ { attemptId: true/false }
      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ê´€ë ¨
      isWrongAnswerTest: false, // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ëª¨ë“œ ì—¬ë¶€
      wrongAnswerQuestions: [], // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ë¬¸ì œ ëª©ë¡
      wrongAnswerAttemptId: null, // ì–´ë–¤ ì‹œë„ì˜ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ì¸ì§€
      retestRound: null, // ì¬ì‹œí—˜ íšŒì°¨ (1 ë˜ëŠ” 2)
      // Canvas ê´€ë ¨
      currentCanvas: null,
      penColor: '#000000',
      penSize: 3,
      canvasStrokes: [], // íš ê¸°ë¡: [{points: [{x, y}, ...], color, width}]
      isEraserMode: false, // ì§€ìš°ê°œ ëª¨ë“œ ì—¬ë¶€
      // í€´ì¦ˆ ì§„í–‰ ê´€ë ¨
      quizStartTime: null, // í€´ì¦ˆ ì‹œì‘ ì‹œê°„
      questionStartTime: null, // í˜„ì¬ ë¬¸ì œ ì‹œì‘ ì‹œê°„
      questionPausedElapsed: 0, // ì¼ì‹œì •ì§€ëœ ê²½ê³¼ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
      questionTimes: {}, // ê° ë¬¸ì œë³„ ì†Œìš” ì‹œê°„ { questionIndex: timeInMs }
      timerInterval: null, // íƒ€ì´ë¨¸ ì¸í„°ë²Œ
      teacherNotes: {}, // ì„ ìƒë‹˜ ë©”ëª¨ { themeId: { questionIndex: "ë©”ëª¨ ë‚´ìš©" } }
      quizCompleted: false // í€´ì¦ˆ ì™„ë£Œ ì—¬ë¶€ (ê²°ê³¼ ì €ì¥ í›„ ë‹µë³€ ë³€ê²½ ë°©ì§€)
    };

    // ===== Canvas ë“œë¡œì‰ ê´€ë ¨ í•¨ìˆ˜ =====
    function initCanvas(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return null;

      const ctx = canvas.getContext('2d');
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = state.penColor;
      ctx.lineWidth = state.penSize;

      state.currentCanvas = canvas;
      setupCanvasEvents(canvasId);
      return canvas;
    }

    function setupCanvasEvents(canvasId) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      let isDrawing = false;
      let currentStroke = null; // í˜„ì¬ ê·¸ë¦¬ê³  ìˆëŠ” íš

      function getCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches[0]) {
          return {x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top};
        }
        return {x: e.clientX - rect.left, y: e.clientY - rect.top};
      }

      function startDrawing(e) {
        e.preventDefault();
        const coords = getCoordinates(e);
        isDrawing = true;

        if (state.isEraserMode) {
          // ì§€ìš°ê°œ ëª¨ë“œ: ë“œë˜ê·¸ ì‹œì‘ - ì²« ìœ„ì¹˜ì—ì„œë„ ì§€ìš°ê¸°
          const strokeIndex = findStrokeAtPoint(coords.x, coords.y);
          if (strokeIndex !== -1) {
            state.canvasStrokes.splice(strokeIndex, 1);
            redrawCanvas();
          }
        } else {
          // ê·¸ë¦¬ê¸° ëª¨ë“œ: ìƒˆ íš ì‹œì‘
          currentStroke = {
            points: [{x: coords.x, y: coords.y}],
            color: state.penColor,
            width: state.penSize
          };
        }
      }

      function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const coords = getCoordinates(e);

        if (state.isEraserMode) {
          // ì§€ìš°ê°œ ëª¨ë“œ: ì§€ë‚˜ê°€ëŠ” íšì„ ê³„ì† ì§€ìš°ê¸°
          const strokeIndex = findStrokeAtPoint(coords.x, coords.y);
          if (strokeIndex !== -1) {
            state.canvasStrokes.splice(strokeIndex, 1);
            redrawCanvas();
          }
        } else {
          // ê·¸ë¦¬ê¸° ëª¨ë“œ: í˜„ì¬ íšì— ì  ì¶”ê°€
          currentStroke.points.push({x: coords.x, y: coords.y});

          // ì¦‰ì‹œ í™”ë©´ì— ê·¸ë¦¬ê¸° (ë¯¸ë¦¬ë³´ê¸°)
          const lastPoint = currentStroke.points[currentStroke.points.length - 2];
          ctx.strokeStyle = currentStroke.color;
          ctx.lineWidth = currentStroke.width;
          ctx.beginPath();
          ctx.moveTo(lastPoint.x, lastPoint.y);
          ctx.lineTo(coords.x, coords.y);
          ctx.stroke();
        }
      }

      function stopDrawing(e) {
        if (isDrawing) {
          e.preventDefault();
          isDrawing = false;

          // ê·¸ë¦¬ê¸° ëª¨ë“œì—ì„œë§Œ ì™„ì„±ëœ íš ì €ì¥
          if (!state.isEraserMode && currentStroke && currentStroke.points.length > 0) {
            state.canvasStrokes.push(currentStroke);
          }
          currentStroke = null;
        }
      }

      canvas.addEventListener('touchstart', startDrawing, {passive: false});
      canvas.addEventListener('touchmove', draw, {passive: false});
      canvas.addEventListener('touchend', stopDrawing, {passive: false});
      canvas.addEventListener('touchcancel', stopDrawing, {passive: false});
      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseleave', stopDrawing);
    }

    // íŠ¹ì • ì¢Œí‘œì— ìˆëŠ” íš ì°¾ê¸°
    function findStrokeAtPoint(x, y) {
      const threshold = 10; // í„°ì¹˜ ê°ì§€ ë°˜ê²½

      // ê°€ì¥ ìµœê·¼ íšë¶€í„° ì—­ìˆœìœ¼ë¡œ ê²€ìƒ‰ (ìœ„ì— ìˆëŠ” íš ìš°ì„ )
      for (let i = state.canvasStrokes.length - 1; i >= 0; i--) {
        const stroke = state.canvasStrokes[i];

        // íšì˜ ëª¨ë“  ì ê³¼ ê±°ë¦¬ ê³„ì‚°
        for (let j = 0; j < stroke.points.length; j++) {
          const point = stroke.points[j];
          const distance = Math.sqrt(
            Math.pow(point.x - x, 2) + Math.pow(point.y - y, 2)
          );

          if (distance <= threshold + stroke.width / 2) {
            return i; // íš ì¸ë±ìŠ¤ ë°˜í™˜
          }
        }
      }

      return -1; // íšì„ ì°¾ì§€ ëª»í•¨
    }

    // ìº”ë²„ìŠ¤ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
    function redrawCanvas() {
      const canvas = state.currentCanvas;
      if (!canvas) return;

      const ctx = canvas.getContext('2d');

      // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ëª¨ë“  íš ë‹¤ì‹œ ê·¸ë¦¬ê¸°
      state.canvasStrokes.forEach(stroke => {
        if (stroke.points.length < 2) return;

        ctx.strokeStyle = stroke.color;
        ctx.lineWidth = stroke.width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        ctx.beginPath();
        ctx.moveTo(stroke.points[0].x, stroke.points[0].y);

        for (let i = 1; i < stroke.points.length; i++) {
          ctx.lineTo(stroke.points[i].x, stroke.points[i].y);
        }

        ctx.stroke();
      });
    }

    function clearCanvas() {
      const canvas = state.currentCanvas;
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      // ëª¨ë“  íš ê¸°ë¡ ì‚­ì œ
      state.canvasStrokes = [];
    }

    // íœ ëª¨ë“œë¡œ ì „í™˜
    function setPenMode() {
      state.isEraserMode = false;
      render();
    }

    // ì§€ìš°ê°œ ëª¨ë“œ í† ê¸€
    function toggleEraser() {
      state.isEraserMode = !state.isEraserMode;
      render();
    }

    function changePenColor(color) {
      state.penColor = color;
      render();
    }

    function changePenSize(size) {
      state.penSize = size;
      render();
    }

    // ===== íƒ€ì´ë¨¸ ê´€ë ¨ í•¨ìˆ˜ =====
    function startQuestionTimer() {
      // ì¼ì‹œì •ì§€ëœ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ ì‹œì‘ ì‹œê°„ ì„¤ì •
      state.questionStartTime = Date.now() - state.questionPausedElapsed;

      // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì œê±°
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
      }

      // 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
      state.timerInterval = setInterval(() => {
        updateTimerDisplay();
      }, 1000);
    }

    function stopQuestionTimer() {
      if (state.timerInterval) {
        clearInterval(state.timerInterval);
        state.timerInterval = null;

        // í˜„ì¬ê¹Œì§€ ê²½ê³¼í•œ ì‹œê°„ ì €ì¥
        if (state.questionStartTime) {
          state.questionPausedElapsed = Date.now() - state.questionStartTime;
        }
      }
    }

    function saveQuestionTime(questionIndex) {
      if (state.questionStartTime) {
        const elapsed = Date.now() - state.questionStartTime;
        state.questionTimes[questionIndex] = elapsed;
      }
    }

    function updateTimerDisplay() {
      const timerElement = document.getElementById('questionTimer');
      if (!timerElement || !state.questionStartTime) return;

      const elapsed = Date.now() - state.questionStartTime;
      const totalSeconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      // 3ë¶„(180ì´ˆ) ì œí•œ
      const remainingSeconds = 180 - totalSeconds;

      if (remainingSeconds <= 0) {
        timerElement.textContent = '0:00';
        timerElement.classList.add('text-red-500', 'animate-pulse');
        stopQuestionTimer();
      } else {
        const displayMinutes = Math.floor(remainingSeconds / 60);
        const displaySeconds = remainingSeconds % 60;
        timerElement.textContent = `${displayMinutes}:${displaySeconds.toString().padStart(2, '0')}`;

        // 30ì´ˆ ì´í•˜ë©´ ë¹¨ê°„ìƒ‰ ê²½ê³ 
        if (remainingSeconds <= 30) {
          timerElement.classList.add('text-red-500');
        } else {
          timerElement.classList.remove('text-red-500');
        }
      }
    }

    function getTotalQuestionTime() {
      // ì‘ë‹µí•œ ë¬¸ì œë“¤ì˜ ì‹œê°„ë§Œ í•©ì‚°
      return Object.keys(state.answers).reduce((total, questionIndex) => {
        return total + (state.questionTimes[questionIndex] || 0);
      }, 0);
    }

    function formatTime(milliseconds) {
      const totalSeconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      return `${minutes}ë¶„ ${seconds}ì´ˆ`;
    }

    // ===== êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ê´€ë ¨ í•¨ìˆ˜ =====
    function generateWrongAnswerTest(attempt, round = 1) {
      console.log('=== êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ìƒì„± ì‹œì‘ ===');
      console.log('ì¬ì‹œí—˜ íšŒì°¨:', round);
      console.log('Attempt:', attempt);

      const category = categories.find(c => c.id === attempt.categoryId);
      const theme = category.chapters.find(t => t.id === attempt.themeId);

      // ë¨¼ì € ëª¨ë“  í‹€ë¦° ë¬¸ì œë“¤ì„ ìˆ˜ì§‘
      const allWrongQuestions = [];
      theme.questions.forEach((question, qIdx) => {
        const answer = attempt.answers[qIdx];
        // í‹€ë¦° ë¬¸ì œë§Œ ì„ íƒ
        if (answer && !answer.correct) {
          // similarQuestionsê°€ ìˆìœ¼ë©´ í›„ë³´ì— ì¶”ê°€
          if (question.similarQuestions && question.similarQuestions.length > 0) {
            allWrongQuestions.push({
              originalQuestion: question.question,
              originalQuestionIndex: qIdx,
              question: question,
              similarQuestions: question.similarQuestions
            });
          }
        }
      });

      // í‹€ë¦° ë¬¸ì œë“¤ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ 2ê°œë§Œ ì„ íƒ
      const selectedCount = Math.min(2, allWrongQuestions.length);
      const selectedWrongQuestions = [];

      // ë¬´ì‘ìœ„ë¡œ ì„ê¸°
      const shuffled = [...allWrongQuestions].sort(() => Math.random() - 0.5);

      // ì„ íƒëœ ë¬¸ì œë“¤ì—ì„œ ìœ ì‚¬ë¬¸ì œ ëœë¤ ì„ íƒ
      for (let i = 0; i < selectedCount; i++) {
        const wrongQ = shuffled[i];
        const randomIndex = Math.floor(Math.random() * wrongQ.similarQuestions.length);
        const selectedSimilarQuestion = wrongQ.similarQuestions[randomIndex];

        selectedWrongQuestions.push({
          originalQuestion: wrongQ.originalQuestion,
          originalQuestionIndex: wrongQ.originalQuestionIndex,
          question: selectedSimilarQuestion.question,
          answer: selectedSimilarQuestion.answer || "",
          hint: selectedSimilarQuestion.hint || "",
          explanation: selectedSimilarQuestion.explanation || ""
        });
      }

      console.log('ìƒì„±ëœ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ë¬¸ì œ ìˆ˜:', selectedWrongQuestions.length);
      console.log('êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ë¬¸ì œ:', selectedWrongQuestions);

      return selectedWrongQuestions;
    }

    function startWrongAnswerTest(attempt, round = 1) {
      console.log('=== êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì‹œì‘ ===');
      console.log('ì¬ì‹œí—˜ íšŒì°¨:', round);

      const wrongQuestions = generateWrongAnswerTest(attempt, round);

      if (wrongQuestions.length === 0) {
        alert('í‹€ë¦° ë¬¸ì œê°€ ì—†ê±°ë‚˜ ìœ ì‚¬ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      state.isWrongAnswerTest = true;
      state.wrongAnswerQuestions = wrongQuestions;
      state.wrongAnswerAttemptId = attempt.date; // ì‹œë„ ë‚ ì§œë¥¼ IDë¡œ ì‚¬ìš©
      state.retestRound = round; // ì¬ì‹œí—˜ íšŒì°¨ ì €ì¥
      state.selectedCategory = attempt.categoryId;
      state.currentTheme = attempt.themeId;
      state.currentQuestion = 0;
      state.answers = {};
      state.quizStartTime = Date.now();
      state.questionTimes = {};
      state.questionPausedElapsed = 0;
      state.canvasStrokes = [];
      state.isEraserMode = false;
      state.showResults = false;
      stopQuestionTimer();

      render();
      // íƒ€ì´ë¨¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•¨
    }

    function startWrongAnswerTestForStudent(attemptDate, round = 1) {
      console.log('=== ì„ ìƒë‹˜ì´ í•™ìƒ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì‹œì‘ ===', attemptDate);
      console.log('ì¬ì‹œí—˜ íšŒì°¨:', round);

      if (!state.selectedStudent) {
        console.error('ì„ íƒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
        alert('ì„ íƒëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í•™ìƒ UIDë¥¼ ë³„ë„ë¡œ ì €ì¥ (í€´ì¦ˆ ì§„í–‰ ì¤‘ state.selectedStudentê°€ ì‚¬ë¼ì§€ëŠ” ê²ƒì„ ë°©ì§€)
      state.currentStudentUid = state.selectedStudent.id;
      state.currentStudentName = state.selectedStudent.studentName;
      state.currentStudentPhone = state.selectedStudent.phone;
      console.log('ğŸ”’ í•™ìƒ ì •ë³´ ë°±ì—…:', {
        uid: state.currentStudentUid,
        name: state.currentStudentName,
        phone: state.currentStudentPhone
      });

      // adminStudentsì—ì„œ ìµœì‹  í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const latestStudent = state.adminStudents.find(s => s.id === state.selectedStudent.id);
      if (latestStudent) {
        state.selectedStudent = latestStudent;
      }

      const attempts = state.selectedStudent.attempts || [];
      console.log('í•™ìƒì˜ ëª¨ë“  ì‹œë„:', attempts.map(a => ({ date: a.date, theme: a.themeName })));

      const attempt = attempts.find(a => a.date === attemptDate);

      if (!attempt) {
        console.error('í•´ë‹¹ ë‚ ì§œì˜ ì‹œë„ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', attemptDate);
        console.error('ì°¾ìœ¼ë ¤ëŠ” ë‚ ì§œ:', attemptDate);
        console.error('ì‚¬ìš© ê°€ëŠ¥í•œ ë‚ ì§œë“¤:', attempts.map(a => a.date));
        alert('í•´ë‹¹ í…ŒìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }

      console.log('ì°¾ì€ ì‹œë„:', attempt);

      // í•™ìŠµ ê¸°ë¡ ëª¨ë“œ í•´ì œ (êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ í™”ë©´ í‘œì‹œë¥¼ ìœ„í•´)
      state.showStudentRecords = false;

      // ê¸°ì¡´ startWrongAnswerTest í•¨ìˆ˜ í˜¸ì¶œ
      startWrongAnswerTest(attempt, round);
    }

    async function uploadCanvasImage(canvas, studentId, questionIndex) {
      try {
        const maxWidth = 800;
        const quality = 0.6;
        let width = canvas.width;
        let height = canvas.height;

        if (width > maxWidth) {
          const ratio = maxWidth / width;
          width = maxWidth;
          height = height * ratio;
        }

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = width;
        tempCanvas.height = height;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.drawImage(canvas, 0, 0, width, height);

        const blob = await new Promise(resolve => {
          tempCanvas.toBlob(resolve, 'image/jpeg', quality);
        });

        const filename = `handwriting/${studentId}/q${questionIndex}_${Date.now()}.jpg`;
        const storageRef = storage.ref(filename);
        const snapshot = await storageRef.put(blob);
        const downloadUrl = await snapshot.ref.getDownloadURL();

        return downloadUrl;
      } catch (error) {
        console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        throw error;
      }
    }

    // ìë™ ë¡œê·¸ì¸ ì²´í¬
    function checkAutoLogin() {
      // í•™ìƒ ìë™ ë¡œê·¸ì¸ ì²´í¬
      const savedName = localStorage.getItem('ox_quiz_student_name');
      const savedPhone = localStorage.getItem('ox_quiz_student_phone');
      const savedTeacher = localStorage.getItem('ox_quiz_teacher_name');
      const studentAutoLoginEnabled = localStorage.getItem('ox_quiz_auto_login') === 'true';

      if (studentAutoLoginEnabled && savedName && savedPhone) {
        console.log('í•™ìƒ ìë™ ë¡œê·¸ì¸ ì‹œë„:', savedName);
        state.studentName = savedName;
        state.phone = savedPhone;
        state.teacherName = savedTeacher || '';
        state.autoLogin = true;
        state.userType = 'student';
        return { type: 'student' };
      }

      // ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸ ì²´í¬
      const savedAdminName = localStorage.getItem('ox_quiz_admin_name');
      const adminAutoLoginEnabled = localStorage.getItem('ox_quiz_admin_auto_login') === 'true';

      if (adminAutoLoginEnabled && savedAdminName) {
        console.log('ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸ ì‹œë„:', savedAdminName);
        state.adminName = savedAdminName;
        state.autoLogin = true;
        state.userType = 'admin';
        return { type: 'admin', name: savedAdminName };
      }

      return null;
    }

    // ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
    function saveLoginInfo(name, phone, teacher, autoLogin) {
      localStorage.setItem('ox_quiz_student_name', name);
      localStorage.setItem('ox_quiz_student_phone', phone);
      localStorage.setItem('ox_quiz_teacher_name', teacher);
      localStorage.setItem('ox_quiz_auto_login', autoLogin ? 'true' : 'false');
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      localStorage.removeItem('ox_quiz_student_name');
      localStorage.removeItem('ox_quiz_student_phone');
      localStorage.removeItem('ox_quiz_teacher_name');
      localStorage.removeItem('ox_quiz_auto_login');
      localStorage.removeItem('ox_quiz_admin_name');
      localStorage.removeItem('ox_quiz_admin_auto_login');
      state.isLoggedIn = false;
      state.userType = null;
      state.studentName = '';
      state.phone = '';
      state.teacherName = '';
      state.adminName = '';
      state.uid = '';
      state.selectedCategory = null;
      state.currentTheme = null;
      state.autoLogin = false;
      state.adminStudents = [];
      state.selectedStudent = null;
      render();
    }

    // Firebase í•¨ìˆ˜
    async function loadData(id) {
      try {
        const doc = await db.collection('oral-test-students').doc(id).get();
        if (doc.exists) {
          const studentData = doc.data();
          // Firebaseì—ì„œ ê°€ì ¸ì˜¨ studentNameì„ ì‚¬ìš© (ì •í™•í•œ í‚¤ ë§¤ì¹­ì„ ìœ„í•´)
          const studentName = studentData.studentName || state.studentName;
          state.allStudentData[studentName] = studentData;
          state.lockTimers = studentData.lockTimers || {};
          // ê¸°ì¡´ ë°ì´í„°ì—ì„œ teacherName ê°€ì ¸ì˜¤ê¸°
          if (!state.teacherName && studentData.teacherName) {
            state.teacherName = studentData.teacherName;
          }
          // state.studentNameë„ Firebaseì˜ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ì¼ê´€ì„± ìœ ì§€)
          if (studentData.studentName) {
            state.studentName = studentData.studentName;
          }
          console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ - studentName:', studentName, 'attempts:', studentData.attempts?.length || 0);
        } else {
          console.log('ìƒˆ í•™ìƒ ë°ì´í„° ìƒì„±:', state.studentName);
          state.allStudentData[state.studentName] = {
            attempts: [],
            lockTimers: {},
            teacherName: state.teacherName,
            studentName: state.studentName,
            phone: state.phone,
            status: 'active' // ì‹ ê·œ í•™ìƒì€ ì¬ì›ìƒìœ¼ë¡œ ì‹œì‘
          };
          state.lockTimers = {};
        }
      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        state.allStudentData[state.studentName] = {
          attempts: [],
          lockTimers: {},
          teacherName: state.teacherName,
          studentName: state.studentName,
          phone: state.phone,
          status: 'active'
        };
        state.lockTimers = {};
      }
    }

    async function saveData(newData, uid = null) {
      const targetUid = uid || state.uid;

      // ì˜¨ë¼ì¸ ì €ì¥ ì¬ì‹œë„ ë¡œì§ (ìµœëŒ€ 3íšŒ)
      const maxRetries = 3;
      let retryCount = 0;
      let saveSuccess = false;

      while (retryCount < maxRetries && !saveSuccess) {
        try {
          if (navigator.onLine) {
            await db.collection('oral-test-students').doc(targetUid).set(newData);
            console.log('ì˜¨ë¼ì¸ ì €ì¥ ì™„ë£Œ (ì‹œë„:', retryCount + 1, '/', maxRetries, ')');
            saveSuccess = true;

            // ì„ ìƒë‹˜ì´ í•™ìƒ ë°ì´í„°ë¥¼ ì €ì¥í•œ ê²½ìš°, í•™ìƒ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
            if (state.userType === 'admin' && uid) {
              console.log('ì„ ìƒë‹˜ í•™ìƒ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ ì¤‘...');
              await loadAdminStudents(state.adminName);
              console.log('í•™ìƒ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ ì™„ë£Œ');

              // selectedStudentë„ ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸
              if (state.selectedStudent && state.selectedStudent.id) {
                const updatedStudent = state.adminStudents.find(s => s.id === state.selectedStudent.id);
                if (updatedStudent) {
                  state.selectedStudent = updatedStudent;
                  console.log('âœ… selectedStudentë¥¼ ìµœì‹  ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸:', updatedStudent.attempts?.length, 'ê°œì˜ ì‹œë„');
                }
              }
            }
          } else {
            await saveToIndexedDB(newData);
            console.log('ì˜¤í”„ë¼ì¸ ì„ì‹œ ì €ì¥ ì™„ë£Œ');
            alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ ìë™ìœ¼ë¡œ ë™ê¸°í™”ë©ë‹ˆë‹¤.');
            saveSuccess = true; // ë¡œì»¬ ì €ì¥ ì„±ê³µ
          }
        } catch (error) {
          retryCount++;
          console.error('ë°ì´í„° ì €ì¥ ì˜¤ë¥˜ (ì‹œë„:', retryCount, '/', maxRetries, '):', error);

          if (retryCount >= maxRetries) {
            // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼ ì‹œ ë¡œì»¬ ì €ì¥
            await saveToIndexedDB(newData);
            alert('ì˜¨ë¼ì¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë¥¼ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
          } else {
            // ì¬ì‹œë„ ì „ ì ì‹œ ëŒ€ê¸° (1ì´ˆ)
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      }

      return saveSuccess;
    }

    // ê´€ë¦¬ì í•¨ìˆ˜
    async function loadAdminStudents(teacherName) {
      try {
        const snapshot = await db.collection('oral-test-students')
          .where('teacherName', '==', teacherName)
          .get();
        
        const students = [];
        snapshot.forEach(doc => {
          students.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        state.adminStudents = students;
        console.log('í•™ìƒ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', students.length, 'ëª…');
      } catch (error) {
        console.error('í•™ìƒ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
        state.adminStudents = [];
      }
    }

    async function registerAdmin(adminName, secretKey) {
      if (secretKey !== ADMIN_SECRET_KEY) {
        alert('ë³´ì•ˆ í‚¤ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return false;
      }

      try {
        const adminId = `admin_${adminName}`;
        // students ì»¬ë ‰ì…˜ì— ê´€ë¦¬ì ì •ë³´ ì €ì¥ (isAdmin: true í”Œë˜ê·¸ ì¶”ê°€)
        await db.collection('oral-test-students').doc(adminId).set({
          name: adminName,
          isAdmin: true,
          registeredAt: new Date().toISOString()
        });
        
        alert('ê´€ë¦¬ì ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        return true;
      } catch (error) {
        console.error('ê´€ë¦¬ì ë“±ë¡ ì˜¤ë¥˜:', error);
        alert('ê´€ë¦¬ì ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        return false;
      }
    }

    async function checkAdminExists(adminName) {
      try {
        const adminId = `admin_${adminName}`;
        const doc = await db.collection('oral-test-students').doc(adminId).get();
        return doc.exists && doc.data()?.isAdmin === true;
      } catch (error) {
        console.error('ê´€ë¦¬ì í™•ì¸ ì˜¤ë¥˜:', error);
        return false;
      }
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function getThemeStatus(categoryId, themeId) {
      const attempts = state.allStudentData[state.studentName]?.attempts || [];
      const themeAttempts = attempts.filter(a => a.categoryId === categoryId && a.themeId === themeId);
      
      if (themeAttempts.length === 0) return { status: 'new', lastAttempt: null, attemptCount: 0 };
      
      const lastAttempt = themeAttempts[themeAttempts.length - 1];
      const percentage = lastAttempt.percentage;
      
      return { 
        status: percentage === 100 ? 'completed' : 'retry', 
        lastAttempt, 
        attemptCount: themeAttempts.length
      };
    }

    function isLocked(categoryId, themeId) {
      const lockUntil = state.lockTimers[`${state.studentName}-${categoryId}-${themeId}`];
      if (!lockUntil) return false;
      return state.currentTime < lockUntil;
    }

    function getRemainingTime(categoryId, themeId) {
      const lockUntil = state.lockTimers[`${state.studentName}-${categoryId}-${themeId}`];
      if (!lockUntil) return 0;
      const remaining = Math.max(0, Math.ceil((lockUntil - state.currentTime) / 1000));
      return remaining;
    }

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    async function handleStudentLogin(autoLoginChecked = false, isNewStudent = false) {
      if (state.studentName.trim() && state.phone.trim()) {
        const p = state.phone.replace(/[^0-9]/g, '');
        if (p.length < 10 || p.length > 11) {
          alert('ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (10-11ìë¦¬)');
          return;
        }

        if (isNewStudent && !state.teacherName.trim()) {
          alert('ë‹´ë‹¹ ì„ ìƒë‹˜ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        state.loading = true;
        render();
        const id = `${state.studentName.trim()}_${p}`;
        state.uid = id;
        
        saveLoginInfo(state.studentName.trim(), p, state.teacherName.trim(), autoLoginChecked);
        
        await loadData(id);
        
        // í‡´ì›ìƒ ì²´í¬
        const studentData = state.allStudentData[state.studentName];
        if (studentData && studentData.status === 'withdrawn') {
          state.loading = false;
          alert('í‡´ì› ì²˜ë¦¬ëœ í•™ìƒì€ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\\në‹´ë‹¹ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
          logout();
          return;
        }
        
        // ì‹ ê·œ í•™ìƒì¸ ê²½ìš° ì„ ìƒë‹˜ ì •ë³´ ì €ì¥
        if (isNewStudent) {
          const newData = {
            ...state.allStudentData[state.studentName],
            teacherName: state.teacherName.trim(),
            studentName: state.studentName.trim(),
            phone: p,
            status: 'active'
          };
          await saveData(newData);
        }
        
        state.isLoggedIn = true;
        state.userType = 'student';
        state.loading = false;
        render();
      }
    }

    async function handleAdminLogin() {
      if (!state.adminName.trim()) {
        alert('ê´€ë¦¬ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const adminPassword = document.getElementById('adminPasswordInput')?.value;
      if (!adminPassword) {
        alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (adminPassword !== ADMIN_PASSWORD) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      // ìë™ ë¡œê·¸ì¸ ì²´í¬ë°•ìŠ¤ í™•ì¸ (render ì „ì— ë¨¼ì € í™•ì¸)
      const autoLoginChecked = document.getElementById('adminAutoLoginCheckbox')?.checked || false;
      console.log('ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸ ì²´í¬:', autoLoginChecked);

      state.loading = true;
      render();

      const exists = await checkAdminExists(state.adminName.trim());
      
      if (!exists) {
        state.loading = false;
        alert('ë“±ë¡ë˜ì§€ ì•Šì€ ê´€ë¦¬ìì…ë‹ˆë‹¤. ë¨¼ì € ê´€ë¦¬ì ë“±ë¡ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
        render();
        return;
      }

      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥
      if (autoLoginChecked) {
        console.log('ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸ ì •ë³´ ì €ì¥:', state.adminName.trim());
        localStorage.setItem('ox_quiz_admin_name', state.adminName.trim());
        localStorage.setItem('ox_quiz_admin_auto_login', 'true');
      }

      await loadAdminStudents(state.adminName.trim());
      
      state.isLoggedIn = true;
      state.userType = 'admin';
      state.loading = false;
      render();
    }

    function handleStartQuiz(themeId) {
      if (isLocked(state.selectedCategory, themeId)) return;

      console.log('ğŸ¯ ì¼ë°˜ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì‹œì‘ - isWrongAnswerTestë¥¼ falseë¡œ ì„¤ì •');
      state.isWrongAnswerTest = false; // ì¼ë°˜ í…ŒìŠ¤íŠ¸ì„ì„ ëª…ì‹œ
      state.wrongAnswerQuestions = []; // ì¬ì‹œí—˜ ê´€ë ¨ ìƒíƒœ ì´ˆê¸°í™”
      state.wrongAnswerAttemptId = null;
      state.retestRound = null;

      state.currentTheme = themeId;
      state.currentQuestion = 0;
      state.answers = {};
      state.quizStartTime = Date.now(); // í€´ì¦ˆ ì‹œì‘ ì‹œê°„ ê¸°ë¡
      state.questionTimes = {}; // ë¬¸ì œë³„ ì‹œê°„ ì´ˆê¸°í™”
      state.questionPausedElapsed = 0; // ì¼ì‹œì •ì§€ ì‹œê°„ ì´ˆê¸°í™”
      state.canvasStrokes = []; // ìº”ë²„ìŠ¤ íš ì´ˆê¸°í™”
      state.isEraserMode = false; // ì§€ìš°ê°œ ëª¨ë“œ í•´ì œ
      stopQuestionTimer(); // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
      render();
      // íƒ€ì´ë¨¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•¨
    }

    async function handleAnswer(selectedAnswer) {
      // í€´ì¦ˆ ì™„ë£Œ í›„ì—ëŠ” ë‹µë³€ ë³€ê²½ ë¶ˆê°€
      if (state.quizCompleted) {
        return;
      }

      const key = state.currentQuestion;

      // ê¸°ì¡´ ë‹µë³€ì´ ìˆëŠ” ê²½ìš°, ì´ë¯¸ì§€ URL ë³´ì¡´
      const existingImageUrl = state.answers[key]?.imageUrl || null;

      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      const question = theme.questions[state.currentQuestion];
      // O/XëŠ” ì„ ìƒë‹˜ì´ ì§ì ‘ í‰ê°€í•˜ëŠ” ë²„íŠ¼ (O = ì •ë‹µ, X = ì˜¤ë‹µ)
      const isCorrect = selectedAnswer === 'O';

      const status = getThemeStatus(state.selectedCategory, state.currentTheme);
      const isRetake = status.attemptCount >= 1;

      // Canvas ì´ë¯¸ì§€ ì—…ë¡œë“œ (ìˆëŠ” ê²½ìš°, ìƒˆë¡œ ê·¸ë¦° ê²½ìš°ë§Œ)
      let imageUrl = existingImageUrl;
      if (state.currentCanvas && state.canvasStrokes.length > 0) {
        try {
          imageUrl = await uploadCanvasImage(
            state.currentCanvas,
            state.studentId,
            state.currentQuestion
          );
        } catch (error) {
          console.error('Canvas ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
          // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨í•´ë„ ë‹µë³€ì€ ì €ì¥
        }
      }

      // ë¬¸ì œ ì‹œê°„ ì €ì¥ (ì²˜ìŒ ë‹µë³€í•  ë•Œë§Œ)
      if (!state.answers[key]) {
        saveQuestionTime(key);
      }

      state.answers[key] = {
        selected: selectedAnswer,
        correct: isCorrect,
        isRetake,
        imageUrl
      };
      render();
    }

    function handleNext() {
      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);
      if (state.currentQuestion < theme.questions.length - 1) {
        // í˜„ì¬ ë¬¸ì œê°€ ì•„ì§ ë‹µë³€ ì•ˆ ë˜ì—ˆìœ¼ë©´ ì‹œê°„ ì €ì¥ (ê±´ë„ˆë›¸ ë•Œ)
        if (!state.answers[state.currentQuestion]) {
          saveQuestionTime(state.currentQuestion);
        }

        state.currentQuestion++;
        state.canvasStrokes = []; // ë‹¤ìŒ ë¬¸ì œë¡œ ì´ë™ ì‹œ ìº”ë²„ìŠ¤ íš ì´ˆê¸°í™”
        state.isEraserMode = false; // ì§€ìš°ê°œ ëª¨ë“œ í•´ì œ
        state.questionPausedElapsed = 0; // ì¼ì‹œì •ì§€ ì‹œê°„ ì´ˆê¸°í™”
        state.questionStartTime = null; // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”

        // íƒ€ì´ë¨¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•¨
        stopQuestionTimer();

        render();
      }
    }

    function handlePrev() {
      if (state.currentQuestion > 0) {
        // í˜„ì¬ ë¬¸ì œê°€ ì•„ì§ ë‹µë³€ ì•ˆ ë˜ì—ˆìœ¼ë©´ ì‹œê°„ ì €ì¥
        if (!state.answers[state.currentQuestion]) {
          saveQuestionTime(state.currentQuestion);
        }

        state.currentQuestion--;
        state.canvasStrokes = []; // ì´ì „ ë¬¸ì œë¡œ ì´ë™ ì‹œ ìº”ë²„ìŠ¤ íš ì´ˆê¸°í™”
        state.isEraserMode = false; // ì§€ìš°ê°œ ëª¨ë“œ í•´ì œ
        state.questionPausedElapsed = 0; // ì¼ì‹œì •ì§€ ì‹œê°„ ì´ˆê¸°í™”
        state.questionStartTime = null; // íƒ€ì´ë¨¸ ì‹œì‘ ì‹œê°„ ì´ˆê¸°í™”

        // íƒ€ì´ë¨¸ëŠ” ìˆ˜ë™ìœ¼ë¡œ ì‹œì‘í•´ì•¼ í•¨
        stopQuestionTimer();

        render();
      }
    }

    async function handleFinishQuiz() {
      console.log('=== handleFinishQuiz ì‹œì‘ ===');

      // í€´ì¦ˆ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì • (ë‹µë³€ ë³€ê²½ ë°©ì§€)
      state.quizCompleted = true;

      // íƒ€ì´ë¨¸ ì •ë¦¬
      stopQuestionTimer();

      const category = categories.find(c => c.id === state.selectedCategory);
      const theme = category.chapters.find(t => t.id === state.currentTheme);

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ëª¨ë“œì¸ì§€ í™•ì¸
      const isWrongTest = state.isWrongAnswerTest;
      const questions = isWrongTest ? state.wrongAnswerQuestions : theme.questions;

      const answeredCount = Object.keys(state.answers).length;
      const correct = Object.values(state.answers).filter(a => a.correct).length;
      const total = questions.length;
      // ì •ë‹µë¥ ì€ ì‘ë‹µí•œ ë¬¸ì œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
      const percentage = answeredCount > 0 ? Math.round((correct / answeredCount) * 100) : 0;

      const wrongQuestions = questions
        .map((q, idx) => ({ ...q, index: idx }))
        .filter(q => state.answers[q.index] && !state.answers[q.index].correct)
        .map(q => q.question);

      // ì‘ë‹µí•œ ë¬¸ì œ ë²ˆí˜¸ ëª©ë¡
      const answeredQuestions = Object.keys(state.answers).map(Number).sort((a, b) => a - b);

      // ì´ ì†Œìš” ì‹œê°„ ê³„ì‚° - ì‘ë‹µí•œ ë¬¸ì œë“¤ì˜ ì‹œê°„ë§Œ í•©ì‚°
      const totalTime = getTotalQuestionTime();
      console.log('ì‘ë‹µí•œ ë¬¸ì œ:', answeredQuestions);
      console.log('ê° ë¬¸ì œ ì†Œìš” ì‹œê°„:', state.questionTimes);
      console.log('ì´ ì†Œìš” ì‹œê°„:', formatTime(totalTime));

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ì€ ë³„ë„ì˜ í‚¤ë¡œ ì„ ìƒë‹˜ ë©”ëª¨ ì €ì¥
      const noteKey = isWrongTest
        ? state.currentTheme + '_retest_' + state.wrongAnswerAttemptId + '_' + (state.retestRound || 1)
        : state.currentTheme;

      const attemptData = {
        categoryId: state.selectedCategory,
        categoryName: category.name,
        themeId: state.currentTheme,
        themeName: theme.name,
        date: new Date().toLocaleString('ko-KR'),
        correct,
        total,
        answeredCount, // ì‘ë‹µí•œ ë¬¸ì œ ìˆ˜
        answeredQuestions, // ì‘ë‹µí•œ ë¬¸ì œ ë²ˆí˜¸ë“¤
        percentage,
        wrongQuestions,
        answers: { ...state.answers },
        totalTime, // ì´ ì†Œìš” ì‹œê°„ (ë°€ë¦¬ì´ˆ) - ì‘ë‹µí•œ ë¬¸ì œë“¤ì˜ í•©
        questionTimes: { ...state.questionTimes }, // ê° ë¬¸ì œë³„ ì†Œìš” ì‹œê°„
        teacherNotes: state.teacherNotes[noteKey] || {}, // ì„ ìƒë‹˜ ë©”ëª¨
        isWrongAnswerTest: isWrongTest, // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì—¬ë¶€
        wrongAnswerAttemptId: isWrongTest ? state.wrongAnswerAttemptId : null, // ì›ë³¸ ì‹œë„ ID
        retestRound: isWrongTest ? (state.retestRound || 1) : null // ì¬ì‹œí—˜ íšŒì°¨ (1 ë˜ëŠ” 2)
      };

      console.log('ì €ì¥í•  attemptData:', attemptData);

      // ì„ ìƒë‹˜ì´ í•™ìƒì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•œ ê²½ìš°, í•™ìƒ ë°ì´í„°ì— ì €ì¥
      const targetStudentName = (state.userType === 'admin' && state.selectedStudent)
        ? state.selectedStudent.studentName
        : state.studentName;

      const targetStudentPhone = (state.userType === 'admin' && state.selectedStudent)
        ? state.selectedStudent.phone
        : state.phone;

      const targetTeacherName = (state.userType === 'admin' && state.selectedStudent)
        ? state.selectedStudent.teacherName || state.adminName
        : state.teacherName;

      // ì„ ìƒë‹˜ ëª¨ë“œì—ì„œëŠ” selectedStudentì˜ ìµœì‹  ë°ì´í„°ë¥¼ ì‚¬ìš©
      // í•™ìƒ ëª¨ë“œì—ì„œëŠ” allStudentData ì‚¬ìš©
      const baseData = (state.userType === 'admin' && state.selectedStudent)
        ? state.selectedStudent
        : state.allStudentData[targetStudentName];

      console.log('=== ë°ì´í„° ê¸°ë°˜ í™•ì¸ ===');
      console.log('baseData:', baseData);
      console.log('ê¸°ì¡´ attempts ìˆ˜:', baseData?.attempts?.length || 0);

      const newData = {
        ...baseData,
        attempts: [...(baseData?.attempts || []), attemptData],
        teacherName: targetTeacherName,
        studentName: targetStudentName,
        phone: targetStudentPhone
      };

      console.log('ìƒˆë¡œìš´ attempts ìˆ˜:', newData.attempts.length);

      // ì„ ìƒë‹˜ ëª¨ë“œì—ì„œëŠ” í•™ìƒì˜ IDë¥¼ ë³´ì¡´í•´ì•¼ í•¨
      if (state.userType === 'admin' && state.selectedStudent?.id) {
        newData.id = state.selectedStudent.id;
      }

      if (percentage < 100) {
        const lockUntil = Date.now() + 60000;
        state.lockTimers[`${targetStudentName}-${state.selectedCategory}-${state.currentTheme}`] = lockUntil;
        newData.lockTimers = state.lockTimers;
      }

      state.allStudentData[targetStudentName] = newData;

      // ì„ ìƒë‹˜ì´ ì§„í–‰í•œ ê²½ìš°, í•™ìƒì˜ UIDë¡œ ì €ì¥
      console.log('=== saveUid ê²°ì • ===');
      console.log('state.userType:', state.userType);
      console.log('state.selectedStudent:', state.selectedStudent);
      console.log('state.selectedStudent?.id:', state.selectedStudent?.id);
      console.log('state.currentStudentUid (ë°±ì—…):', state.currentStudentUid);
      console.log('state.uid:', state.uid);

      let saveUid;
      if (state.userType === 'admin') {
        // ì„ ìƒë‹˜ ëª¨ë“œ: selectedStudent ë˜ëŠ” ë°±ì—…ëœ currentStudentUid ì‚¬ìš©
        saveUid = state.selectedStudent?.id || state.currentStudentUid;
        console.log('ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ ëª¨ë“œ - saveUid:', saveUid);
      } else {
        // í•™ìƒ ëª¨ë“œ: state.uid ì‚¬ìš©
        saveUid = state.uid;
        console.log('ğŸ‘¨â€ğŸ“ í•™ìƒ ëª¨ë“œ - saveUid:', saveUid);
      }

      console.log('=== í€´ì¦ˆ ì™„ë£Œ í›„ ë°ì´í„° ì €ì¥ ===');
      console.log('ì €ì¥ ì‹œì‘ - targetStudentName:', targetStudentName);
      console.log('ì €ì¥ ì‹œì‘ - saveUid:', saveUid);
      console.log('ì €ì¥í•  attempts ìˆ˜:', newData.attempts?.length || 0);
      console.log('ì €ì¥í•  newData:', newData);

      if (!saveUid) {
        console.error('âŒ saveUidê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤! ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        console.error('state.userType:', state.userType);
        console.error('state.selectedStudent:', state.selectedStudent);
        console.error('state.currentStudentUid:', state.currentStudentUid);
        console.error('state.uid:', state.uid);
        alert('ì €ì¥ ì˜¤ë¥˜: í•™ìƒ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì„ ìƒë‹˜ í™”ë©´ì—ì„œ í•™ìƒì„ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      await saveData(newData, saveUid);

      console.log('Firebase ì €ì¥ ì™„ë£Œ!');
      console.log('í•™ìƒ UID:', saveUid, 'ì— ì €ì¥ë¨');

      // ì„ ìƒë‹˜ì´ ì§„í–‰í•œ ê²½ìš°, selectedStudent ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
      if (state.userType === 'admin' && state.selectedStudent) {
        state.selectedStudent = newData;
      }

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì™„ë£Œ í›„ í•™ìŠµ ê¸°ë¡ìœ¼ë¡œ ì´ë™
      if (isWrongTest) {
        state.isWrongAnswerTest = false;
        state.wrongAnswerQuestions = [];
        state.wrongAnswerAttemptId = null;
        state.retestRound = null;

        // ì„ ìƒë‹˜ì´ ì§„í–‰í•œ ê²½ìš° â†’ í•™ìƒ ìƒì„¸ ê¸°ë¡ í™”ë©´ìœ¼ë¡œ
        if (state.userType === 'admin' && state.selectedStudent) {
          state.showStudentRecords = true;
          state.selectedCategory = null; // í•™ìŠµ ê¸°ë¡ í™”ë©´ìœ¼ë¡œ ê°€ê¸° ìœ„í•´ ì¹´í…Œê³ ë¦¬ ì´ˆê¸°í™”
        } else {
          // í•™ìƒì´ ì§„í–‰í•œ ê²½ìš° â†’ í•™ìŠµ ê¸°ë¡ í™”ë©´ìœ¼ë¡œ
          state.showResults = true;
        }
      }

      state.currentTheme = null;
      state.currentQuestion = 0;
      state.answers = {};
      state.quizStartTime = null;
      state.questionTimes = {}; // ë¬¸ì œë³„ ì‹œê°„ ì´ˆê¸°í™”
      state.quizCompleted = false; // í€´ì¦ˆ ì™„ë£Œ í”Œë˜ê·¸ ì´ˆê¸°í™”

      if (!isWrongTest) {
        state.selectedCategory = null;
      }

      console.log('=== handleFinishQuiz ì™„ë£Œ ===');
      render();
    }

    // ë Œë”ë§ í•¨ìˆ˜
    let isRendering = false;
    let renderCount = 0;
    function render() {
      if (isRendering) {
        console.log('âš ï¸ render() ì°¨ë‹¨ë¨ (ì´ë¯¸ ë Œë”ë§ ì¤‘)');
        return;
      }
      isRendering = true;
      renderCount++;

      console.log(`\nğŸ”„ ========== render() í˜¸ì¶œ #${renderCount} ==========`);
      console.log('í˜„ì¬ state:', {
        userType: state.userType,
        isLoggedIn: state.isLoggedIn,
        studentName: state.studentName,
        isWrongAnswerTest: state.isWrongAnswerTest,
        wrongAnswerQuestions_length: state.wrongAnswerQuestions?.length,
        showResults: state.showResults,
        selectedCategory: state.selectedCategory
      });

      const app = document.getElementById('app');

      if (state.loading) {
        app.innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
              <div class="w-16 h-16 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
              <p class="text-white font-bold">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
          </div>
        `;
        isRendering = false;
        return;
      }

      if (!state.isLoggedIn) {
        if (state.showAdminRegister) {
          renderAdminRegister(app);
        } else {
          renderLogin(app);
        }
        // ë¡œê·¸ì¸ í™”ë©´ì€ ìˆ˜ì‹ì´ ì—†ìœ¼ë¯€ë¡œ ì¦‰ì‹œ í‘œì‹œ
        if (!app.classList.contains('ready')) {
          app.classList.add('ready');
        }
        isRendering = false;
        return;
      }

      if (state.userType === 'admin') {
        console.log('â†’ renderAdminScreen() í˜¸ì¶œ');
        renderAdminScreen(app);
      } else {
        console.log('â†’ renderMainScreen() í˜¸ì¶œ');
        renderMainScreen();
      }

      console.log(`âœ… render() #${renderCount} ì™„ë£Œ\n`);
      isRendering = false;

      // 100ms í›„ì— ë‹¤ì‹œ renderê°€ í˜¸ì¶œë˜ëŠ”ì§€ ì²´í¬
      setTimeout(() => {
        const currentCount = renderCount;
        setTimeout(() => {
          if (renderCount > currentCount) {
            console.log(`âš ï¸ ê²½ê³ : render() #${currentCount} ì´í›„ ì¶”ê°€ render() í˜¸ì¶œë¨! (í˜„ì¬: #${renderCount})`);
          }
        }, 10);
      }, 100);

      // DOM ì—…ë°ì´íŠ¸ í›„ KaTeX ë Œë”ë§ (ë””ë°”ìš´ì‹± ì ìš©ë¨)
      renderMath();
    }

    // KaTeX ë Œë”ë§ í•¨ìˆ˜ (ê°•ë ¥í•œ ë””ë°”ìš´ì‹±)
    let renderMathTimeout = null;
    let isRenderingMath = false;
    let lastRenderTime = 0;
    let isFirstRender = true;

    function renderMath() {
      // KaTeXê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
      if (typeof renderMathInElement === 'undefined') {
        // KaTeXê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
        setTimeout(renderMath, 50);
        return;
      }

      const app = document.getElementById('app');
      if (!app) return;

      // KaTeX ë Œë”ë§ ì‹¤í–‰ (í™”ë©´ì— ë³´ì´ê¸° ì „ì—)
      try {
        renderMathInElement(app, {
          delimiters: [
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError: false,
          ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
          // â‰ , >, < ê°™ì€ HTML ì—”í‹°í‹°ëŠ” ë¬´ì‹œ
          trust: (context) => ['\\htmlId', '\\href'].includes(context.command)
        });
        console.log('âœ“ KaTeX ë Œë”ë§ ì™„ë£Œ');
      } catch (error) {
        console.error('KaTeX ë Œë”ë§ ì˜¤ë¥˜:', error);
      }

      // ë Œë”ë§ ì™„ë£Œ í›„ í™”ë©´ í‘œì‹œ (SSRì²˜ëŸ¼ ë³´ì´ë„ë¡)
      if (!app.classList.contains('ready')) {
        // ì•„ì£¼ ì§§ì€ ì§€ì—°ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œì‹œ
        setTimeout(() => {
          app.classList.add('ready');
          console.log('âœ“ ì•± í‘œì‹œ (ìˆ˜ì‹ ë Œë”ë§ ì™„ë£Œ)');
        }, 10);
      }

      isFirstRender = false;
    }

    function renderLogin(app) {
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="bg-gray-900 rounded-2xl p-8 shadow-2xl border border-orange-500/30">
              <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/50">
                  ${icon('bookOpen', 'text-white', 32)}
                </div>
              </div>
              <h1 class="text-3xl font-bold text-center mb-2 text-white">êµ¬ë‘í…ŒìŠ¤íŠ¸ í€´ì¦ˆ</h1>
              <h2 class="text-xl text-center mb-8 text-orange-500">í™•ë¥ ê³¼ í†µê³„</h2>
              
              <div class="flex gap-2 mb-6">
                <button id="studentBtn" class="flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm">
                  í•™ìƒ
                </button>
                <button id="adminBtn" class="flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all">
                  ê´€ë¦¬ì
                </button>
              </div>

              <div id="loginForm"></div>
            </div>
          </div>
        </div>
      `;

      const studentBtn = document.getElementById('studentBtn');
      const adminBtn = document.getElementById('adminBtn');
      const loginForm = document.getElementById('loginForm');

      function showStudentForm() {
        studentBtn.className = "flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm";
        adminBtn.className = "flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all";
        
        loginForm.innerHTML = `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">í•™ìƒ ì´ë¦„</label>
              <input
                type="text"
                id="nameInput"
                value="${state.studentName}"
                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">ì „í™”ë²ˆí˜¸</label>
              <input
                type="tel"
                id="phoneInput"
                value="${state.phone}"
                placeholder="ì „í™”ë²ˆí˜¸ (- ì—†ì´)"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
              <p class="text-xs text-gray-500 mt-1">ì˜ˆ: 01012345678</p>
            </div>

            <div id="teacherField" style="display: none;">
              <label class="block text-sm font-semibold mb-2 text-gray-300">ë‹´ë‹¹ ì„ ìƒë‹˜ ì„±í•¨</label>
              <input
                type="text"
                id="teacherInput"
                value="${state.teacherName}"
                placeholder="ì„ ìƒë‹˜ ì„±í•¨"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
              <p class="text-xs text-gray-500 mt-1">ì²˜ìŒ ê°€ì…ì‹œì—ë§Œ ì…ë ¥</p>
            </div>

            <div class="flex items-center gap-2">
              <input
                type="checkbox"
                id="newStudentCheck"
                class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2 text-orange-500"
              />
              <label for="newStudentCheck" class="text-sm text-gray-300 cursor-pointer">ì²˜ìŒ ê°€ì…í•˜ëŠ” í•™ìƒì…ë‹ˆë‹¤</label>
            </div>

            <div>
              <label class="flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="autoLoginCheck"
                  ${state.autoLogin ? 'checked' : ''}
                  class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2 text-orange-500"
                />
                <span class="ml-2 text-sm text-gray-300">ìë™ ë¡œê·¸ì¸</span>
              </label>
              <p class="text-xs text-gray-500 mt-1 ml-6">ë‹¤ìŒë¶€í„° ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤</p>
            </div>
            
            <button
              id="loginBtn"
              class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
            >
              ì‹œì‘í•˜ê¸°
            </button>
          </div>
        `;

        const nameInput = document.getElementById('nameInput');
        const phoneInput = document.getElementById('phoneInput');
        const teacherInput = document.getElementById('teacherInput');
        const newStudentCheck = document.getElementById('newStudentCheck');
        const teacherField = document.getElementById('teacherField');
        const loginBtn = document.getElementById('loginBtn');

        nameInput.addEventListener('input', (e) => {
          state.studentName = e.target.value;
        });
        
        phoneInput.addEventListener('input', (e) => {
          state.phone = e.target.value;
        });

        teacherInput.addEventListener('input', (e) => {
          state.teacherName = e.target.value;
        });

        newStudentCheck.addEventListener('change', (e) => {
          teacherField.style.display = e.target.checked ? 'block' : 'none';
        });

        phoneInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            const autoLoginChecked = document.getElementById('autoLoginCheck').checked;
            const isNewStudent = newStudentCheck.checked;
            handleStudentLogin(autoLoginChecked, isNewStudent);
          }
        });

        loginBtn.addEventListener('click', () => {
          const autoLoginChecked = document.getElementById('autoLoginCheck').checked;
          const isNewStudent = newStudentCheck.checked;
          handleStudentLogin(autoLoginChecked, isNewStudent);
        });
      }

      function showAdminForm() {
        studentBtn.className = "flex-1 py-2 px-4 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white text-sm transition-all";
        adminBtn.className = "flex-1 py-2 px-4 bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg font-bold text-white text-sm";
        
        loginForm.innerHTML = `
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">ê´€ë¦¬ì ì´ë¦„</label>
              <input
                type="text"
                id="adminNameInput"
                value="${state.adminName}"
                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div>
              <label class="block text-sm font-semibold mb-2 text-gray-300">ë¹„ë°€ë²ˆí˜¸</label>
              <input
                type="password"
                id="adminPasswordInput"
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
              />
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                id="adminAutoLoginCheckbox"
                class="w-4 h-4 bg-gray-800 border-gray-700 rounded focus:ring-orange-500 focus:ring-2"
              />
              <label for="adminAutoLoginCheckbox" class="ml-2 text-sm text-gray-300">
                ìë™ ë¡œê·¸ì¸
              </label>
            </div>
            
            <button
              id="adminLoginBtn"
              class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
            >
              ë¡œê·¸ì¸
            </button>

            <button
              id="adminRegisterBtn"
              class="w-full py-3 bg-gray-800 hover:bg-gray-700 rounded-xl font-bold text-white transition-all border border-gray-700"
            >
              ê´€ë¦¬ì ë“±ë¡
            </button>
          </div>
        `;

        const adminNameInput = document.getElementById('adminNameInput');
        const adminPasswordInput = document.getElementById('adminPasswordInput');
        const adminLoginBtn = document.getElementById('adminLoginBtn');
        const adminRegisterBtn = document.getElementById('adminRegisterBtn');

        adminNameInput.addEventListener('input', (e) => {
          state.adminName = e.target.value;
        });

        adminPasswordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleAdminLogin();
          }
        });

        adminLoginBtn.addEventListener('click', handleAdminLogin);
        
        adminRegisterBtn.addEventListener('click', () => {
          state.showAdminRegister = true;
          render();
        });
      }

      studentBtn.addEventListener('click', showStudentForm);
      adminBtn.addEventListener('click', showAdminForm);

      showStudentForm();
    }

    function renderAdminRegister(app) {
      app.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="bg-gray-900 rounded-2xl p-8 shadow-2xl border border-orange-500/30">
              <div class="mb-6">
                <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                  ${icon('chevronLeft', '', 16)}ëŒì•„ê°€ê¸°
                </button>
              </div>

              <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/50">
                  ${icon('settings', 'text-white', 32)}
                </div>
              </div>
              
              <h1 class="text-2xl font-bold text-center mb-2 text-white">ê´€ë¦¬ì ë“±ë¡</h1>
              <p class="text-sm text-center mb-6 text-gray-400">ë³´ì•ˆ í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤</p>
              
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-300">ê´€ë¦¬ì ì´ë¦„</label>
                  <input
                    type="text"
                    id="regAdminNameInput"
                    placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2 text-gray-300">ë³´ì•ˆ í‚¤</label>
                  <input
                    type="password"
                    id="secretKeyInput"
                    placeholder="ë³´ì•ˆ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                    class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 text-white placeholder-gray-500 transition-all"
                  />
                  <p class="text-xs text-red-400 mt-1">âš ï¸ ê´€ë¦¬ìë§Œ ì•Œê³  ìˆëŠ” ë³´ì•ˆ í‚¤</p>
                </div>
                
                <button
                  id="registerBtn"
                  class="w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95"
                >
                  ë“±ë¡í•˜ê¸°
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.showAdminRegister = false;
        render();
      });

      const regAdminNameInput = document.getElementById('regAdminNameInput');
      const secretKeyInput = document.getElementById('secretKeyInput');
      const registerBtn = document.getElementById('registerBtn');

      registerBtn.addEventListener('click', async () => {
        const name = regAdminNameInput.value.trim();
        const key = secretKeyInput.value.trim();

        if (!name) {
          alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        if (!key) {
          alert('ë³´ì•ˆ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const success = await registerAdmin(name, key);
        if (success) {
          state.showAdminRegister = false;
          render();
        }
      });
    }

    function renderAdminScreen(app) {
      if (state.selectedStudent) {
        // í•™ìŠµ ê¸°ë¡ ë³´ê¸° ëª¨ë“œì¼ ë•ŒëŠ” ìš°ì„ ì ìœ¼ë¡œ í•™ìƒ ìƒì„¸ ê¸°ë¡ í‘œì‹œ
        if (state.showStudentRecords) {
          renderAdminStudentDetail(app);
          return;
        }

        // ì„ ìƒë‹˜ì´ í•™ìƒì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰ ì¤‘ì¸ ê²½ìš°
        if (state.selectedCategory) {
          if (state.currentTheme === null) {
            renderThemeSelection(app);
          } else {
            renderQuizScreen(app);
          }
          return;
        }

        // ê¸°ë³¸ì ìœ¼ë¡œ ì¹´í…Œê³ ë¦¬ ì„ íƒ í™”ë©´ í‘œì‹œ
        renderAdminCategorySelection(app);
        return;
      }

      // ì¬ì›ìƒ/í‡´ì›ìƒ í•„í„°ë§
      const activeStudents = state.adminStudents.filter(s => s.status !== 'withdrawn');
      const withdrawnStudents = state.adminStudents.filter(s => s.status === 'withdrawn');
      const displayStudents = (state.studentStatusFilter === 'withdrawn') ? withdrawnStudents : activeStudents;
      
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('users', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${state.adminName} ì„ ìƒë‹˜</h2>
                    <p class="text-sm text-gray-400 mt-1">ë‹´ë‹¹ í•™ìƒ ê´€ë¦¬</p>
                  </div>
                </div>
                <button id="logoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm">
                  ë¡œê·¸ì•„ì›ƒ
                </button>
              </div>
            </div>

            <!-- ì¬ì›ìƒ/í‡´ì›ìƒ íƒ­ -->
            <div class="mb-6">
              <div class="flex gap-2 mb-4">
                <button id="activeTab" class="px-6 py-3 rounded-lg font-bold transition-all ${state.studentStatusFilter !== 'withdrawn' ? 'bg-orange-500 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}">
                  ì¬ì›ìƒ (${activeStudents.length}ëª…)
                </button>
                <button id="withdrawnTab" class="px-6 py-3 rounded-lg font-bold transition-all ${state.studentStatusFilter === 'withdrawn' ? 'bg-gray-600 text-white' : 'bg-gray-800 text-gray-400 hover:bg-gray-700'}">
                  í‡´ì›ìƒ (${withdrawnStudents.length}ëª…)
                </button>
              </div>
              
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="flex items-center justify-between">
                  <span class="text-gray-400 text-sm font-semibold">
                    ${state.studentStatusFilter === 'withdrawn' ? 'í‡´ì›ìƒ' : 'ì¬ì›ìƒ'} ìˆ˜
                  </span>
                  <span class="text-2xl font-bold text-orange-400">${displayStudents.length}ëª…</span>
                </div>
              </div>
            </div>

            ${displayStudents.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('users', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">
                  ${state.studentStatusFilter === 'withdrawn' ? 'í‡´ì› ì²˜ë¦¬ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.' : 'ì•„ì§ ë‹´ë‹¹ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.'}
                </p>
                ${state.studentStatusFilter !== 'withdrawn' ? `
                  <p class="text-sm text-gray-500 mt-2">í•™ìƒì´ íšŒì›ê°€ì…í•  ë•Œ ì„ ìƒë‹˜ ì„±í•¨ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.</p>
                ` : ''}
              </div>
            ` : `
              <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${displayStudents.map(student => {
                  const attempts = student.attempts || [];
                  const totalAttempts = attempts.length;
                  const avgPercentage = totalAttempts > 0 
                    ? Math.round(attempts.reduce((sum, a) => sum + a.percentage, 0) / totalAttempts)
                    : 0;
                  const completedThemes = attempts.filter(a => a.percentage === 100).length;

                  return `
                    <button
                      data-student="${student.id}"
                      class="student-btn bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl hover:shadow-orange-500/20 hover:border-orange-500/50 transition-all text-left transform hover:scale-105 active:scale-95"
                    >
                      <div class="flex items-center mb-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                          ${icon('user', 'text-white', 20)}
                        </div>
                        <div>
                          <h3 class="text-base font-bold text-white">${student.studentName || 'ì´ë¦„ ì—†ìŒ'}</h3>
                          <p class="text-xs text-gray-500">${student.phone || ''}</p>
                        </div>
                      </div>
                      
                      <div class="grid grid-cols-3 gap-2 mb-3">
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-orange-400">${totalAttempts}</div>
                          <div class="text-xs text-gray-500">ì‹œë„</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-green-400">${completedThemes}</div>
                          <div class="text-xs text-gray-500">ì™„ë£Œ</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-lg p-2 text-center">
                          <div class="text-lg font-bold text-blue-400">${avgPercentage}%</div>
                          <div class="text-xs text-gray-500">í‰ê· </div>
                        </div>
                      </div>

                      <div class="text-xs text-gray-400 text-right">
                        ìì„¸íˆ ë³´ê¸° â†’
                      </div>
                    </button>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          logout();
        }
      });

      // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
      document.getElementById('activeTab').addEventListener('click', () => {
        state.studentStatusFilter = 'active';
        render();
      });

      document.getElementById('withdrawnTab').addEventListener('click', () => {
        state.studentStatusFilter = 'withdrawn';
        render();
      });

      document.querySelectorAll('.student-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const studentId = btn.dataset.student;
          state.selectedStudent = state.adminStudents.find(s => s.id === studentId);
          render();
        });
      });
    }

    function renderAdminStudentDetail(app) {
      const student = state.selectedStudent;
      const attempts = student.attempts || [];

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="mb-4">
              <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}í•™ìƒ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('user', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${student.studentName || 'ì´ë¦„ ì—†ìŒ'}</h2>
                    <p class="text-sm text-gray-400 mt-1">${student.phone || ''}</p>
                  </div>
                </div>
                ${student.status === 'withdrawn' ? `
                  <button id="reactivateBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    ì¬ì› ì²˜ë¦¬
                  </button>
                ` : `
                  <button id="withdrawBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/>
                    </svg>
                    í‡´ì› ì²˜ë¦¬
                  </button>
                `}
              </div>
              ${student.status === 'withdrawn' ? `
                <div class="bg-yellow-900/30 border border-yellow-600/50 rounded-lg p-3 mt-4">
                  <p class="text-yellow-400 text-sm font-bold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    í‡´ì› ì²˜ë¦¬ëœ í•™ìƒì…ë‹ˆë‹¤
                  </p>
                </div>
              ` : ''}
            </div>

            <div class="grid md:grid-cols-4 gap-4 mb-6">
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-orange-400">${attempts.length}</div>
                  <div class="text-xs text-gray-500 mt-1">ì „ì²´ ì‹œë„</div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400">${attempts.filter(a => a.percentage === 100).length}</div>
                  <div class="text-xs text-gray-500 mt-1">ì™„ë£Œ í…Œë§ˆ</div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400">
                    ${attempts.length > 0 ? Math.round(attempts.reduce((sum, a) => sum + a.percentage, 0) / attempts.length) : 0}%
                  </div>
                  <div class="text-xs text-gray-500 mt-1">í‰ê·  ì •ë‹µë¥ </div>
                </div>
              </div>
              <div class="bg-gray-900 rounded-xl p-4 border border-gray-800">
                <div class="text-center">
                  <div class="text-2xl font-bold text-purple-400">
                    ${attempts.length > 0 ? Math.round(attempts.reduce((sum, a) => sum + a.correct, 0) / attempts.length) : 0}
                  </div>
                  <div class="text-xs text-gray-500 mt-1">í‰ê·  ì •ë‹µ ìˆ˜</div>
                </div>
              </div>
            </div>

            ${attempts.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            ` : `
              <div class="space-y-6">
                ${(() => {
                  // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™” (ë‚ ì§œë§Œ ì¶”ì¶œ, ì‹œê°„ ì œì™¸)
                  const dateGroups = {};
                  attempts.forEach(attempt => {
                    // ë‚ ì§œì—ì„œ ì‹œê°„ ë¶€ë¶„ ì œê±°
                    const dateOnly = attempt.date.split('.')[0] + '.' + attempt.date.split('.')[1] + '.' + attempt.date.split('.')[2];

                    if (!dateGroups[dateOnly]) {
                      dateGroups[dateOnly] = {
                        date: dateOnly,
                        regularTests: [],
                        wrongTests: []
                      };
                    }

                    if (attempt.isWrongAnswerTest) {
                      dateGroups[dateOnly].wrongTests.push(attempt);
                    } else {
                      dateGroups[dateOnly].regularTests.push(attempt);
                    }
                  });

                  // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                  const sortedDates = Object.keys(dateGroups).sort((a, b) => {
                    return new Date(b.replace(/\. /g, '-')) - new Date(a.replace(/\. /g, '-'));
                  });

                  return sortedDates.map((dateKey, groupIdx) => {
                    const group = dateGroups[dateKey];
                    const allTestsInDate = [...group.regularTests, ...group.wrongTests];

                    // í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³„ ê³„ì‚°
                    const totalCorrect = allTestsInDate.reduce((sum, t) => sum + t.correct, 0);
                    const totalIncorrect = allTestsInDate.reduce((sum, t) => sum + ((t.answeredCount || t.total) - t.correct), 0);
                    const totalAnswered = totalCorrect + totalIncorrect;
                    const overallPercentage = totalAnswered > 0 ? Math.round((totalCorrect / totalAnswered) * 100) : 0;

                    // ì´ ì†Œìš”ì‹œê°„ ê³„ì‚° (ë°€ë¦¬ì´ˆ â†’ ë¶„:ì´ˆ)
                    const totalTimeMs = allTestsInDate.reduce((sum, t) => sum + (t.totalTime || 0), 0);
                    const totalMinutes = Math.floor(totalTimeMs / 60000);
                    const totalSeconds = Math.floor((totalTimeMs % 60000) / 1000);
                    const totalTimeStr = totalMinutes > 0
                      ? `${totalMinutes}ë¶„ ${totalSeconds}ì´ˆ`
                      : `${totalSeconds}ì´ˆ`;

                    const dateCardId = `admin-date-${groupIdx}`;
                    const isExpanded = state.expandedAttempts[dateCardId];

                    // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ì´ í•„ìš”í•œ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì°¾ê¸° (í‹€ë¦° ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°)
                    const testsNeedingRetest = group.regularTests.filter(t => {
                      const hasWrongAnswers = (t.answeredCount || t.total) - t.correct > 0;
                      return hasWrongAnswers;
                    }).map(t => {
                      // ì´ í…ŒìŠ¤íŠ¸ì— ëŒ€í•œ ì¬ì‹œí—˜ ì°¾ê¸°
                      const round1 = group.wrongTests.find(w => w.wrongAnswerAttemptId === t.date && w.retestRound === 1);
                      const round2 = group.wrongTests.find(w => w.wrongAnswerAttemptId === t.date && w.retestRound === 2);

                      let availableRounds = [];
                      if (!round1) {
                        // 1íšŒì°¨ê°€ ì—†ìœ¼ë©´ 1íšŒì°¨ ì‹œì‘ ê°€ëŠ¥
                        availableRounds.push(1);
                      } else if (round1.percentage < 100 && !round2) {
                        // 1íšŒì°¨ê°€ 100ì ì´ ì•„ë‹ˆê³  2íšŒì°¨ê°€ ì—†ìœ¼ë©´ 2íšŒì°¨ ì‹œì‘ ê°€ëŠ¥
                        availableRounds.push(2);
                      }

                      return {
                        ...t,
                        availableRounds,
                        round1,
                        round2
                      };
                    }).filter(t => t.availableRounds.length > 0);

                    return `
                      <div class="bg-gray-900 rounded-2xl border border-gray-800 shadow-xl overflow-hidden">
                        <button
                          class="attempt-card-header w-full text-left p-5 hover:bg-gray-800/50 transition-all"
                          data-attempt-id="${dateCardId}"
                        >
                          <div class="flex items-center justify-between mb-4">
                            <div class="flex-1">
                              <h3 class="text-lg font-bold text-white mb-1">${group.date}</h3>
                              <p class="text-xs text-gray-500">ì´ ${totalAnswered}ê°œ ë¬¸ì œ Â· ${totalTimeStr}</p>
                            </div>
                            <div class="text-3xl font-bold ${overallPercentage === 100 ? 'text-green-400' : overallPercentage >= 80 ? 'text-orange-400' : 'text-red-400'}">
                              ${overallPercentage}%
                            </div>
                          </div>

                          <div class="grid grid-cols-3 gap-3 pt-4 border-t border-gray-800">
                            <div class="text-center">
                              <div class="text-xl font-bold text-green-400">${totalCorrect}</div>
                              <div class="text-xs text-gray-500">ë§íŒ ê°œìˆ˜</div>
                            </div>
                            <div class="text-center">
                              <div class="text-xl font-bold text-red-400">${totalIncorrect}</div>
                              <div class="text-xs text-gray-500">í‹€ë¦° ê°œìˆ˜</div>
                            </div>
                            <div class="text-center flex items-center justify-center">
                              <svg class="w-5 h-5 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                              </svg>
                            </div>
                          </div>
                        </button>

                        ${isExpanded ? `
                          <div class="border-t border-gray-800 p-5 bg-gray-800/30">
                            <!-- êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì‹œì‘ ë²„íŠ¼ë“¤ -->
                            ${testsNeedingRetest.length > 0 ? `
                              <div class="mb-6 space-y-2">
                                <h4 class="text-sm font-bold text-purple-400 mb-3">ğŸ“ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì‹œì‘í•˜ê¸°</h4>
                                ${testsNeedingRetest.map(test => {
                                  return test.availableRounds.map(round => `
                                    <button
                                      class="start-wrong-answer-test-btn w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 rounded-xl font-bold text-white transition-all transform hover:scale-105 active:scale-95 shadow-lg text-sm"
                                      data-attempt-date="${test.date}"
                                      data-round="${round}"
                                    >
                                      ${test.themeName} ì¬ì‹œí—˜ ${round}íšŒì°¨ ì‹œì‘ (2ë¬¸ì œ)
                                    </button>
                                  `).join('');
                                }).join('')}
                              </div>
                            ` : ''}

                            <!-- ê° í…ŒìŠ¤íŠ¸ ìƒì„¸ ì •ë³´ -->
                            <div class="space-y-4">
                              ${allTestsInDate.map((test, testIdx) => {
                                const category = categories.find(c => c.id === test.categoryId);
                                const theme = category?.chapters.find(t => t.id === test.themeId);

                                if (!theme) return '';

                                const testCardId = `admin-test-${groupIdx}-${testIdx}`;
                                const isTestExpanded = state.expandedAttempts[testCardId];

                                // ë¬¸ì œ ë¶„ë¥˜
                                const correctQuestions = [];
                                const wrongQuestions = [];
                                const answeredQuestions = test.answeredQuestions || Object.keys(test.answers || {}).map(Number);

                                answeredQuestions.forEach(qIdx => {
                                  const answer = test.answers?.[qIdx];
                                  const question = theme?.questions[qIdx];
                                  if (question) {
                                    if (answer?.correct) {
                                      correctQuestions.push({ idx: qIdx, question, answer });
                                    } else {
                                      wrongQuestions.push({ idx: qIdx, question, answer });
                                    }
                                  }
                                });

                                return `
                                  <div class="bg-gray-900/50 rounded-xl border border-gray-700 overflow-hidden">
                                    <button
                                      class="attempt-card-header w-full text-left p-3 hover:bg-gray-800/30 transition-all"
                                      data-attempt-id="${testCardId}"
                                    >
                                      <div class="flex items-center justify-between">
                                        <div class="flex-1">
                                          <div class="flex items-center gap-2 mb-1">
                                            <h4 class="text-sm font-bold text-white">${test.themeName}</h4>
                                            <span class="text-xs px-2 py-0.5 rounded ${test.isWrongAnswerTest ? 'bg-purple-500/20 text-purple-400' : 'bg-orange-500/20 text-orange-400'}">
                                              ${test.isWrongAnswerTest ? `ì¬ì‹œí—˜ ${test.retestRound || 1}íšŒì°¨` : 'êµ¬ë‘í…ŒìŠ¤íŠ¸'}
                                            </span>
                                          </div>
                                          <p class="text-xs text-gray-500">${test.date}</p>
                                        </div>
                                        <div class="flex items-center gap-3">
                                          <div class="text-right">
                                            <div class="text-lg font-bold ${test.percentage === 100 ? 'text-green-400' : test.percentage >= 80 ? 'text-orange-400' : 'text-red-400'}">
                                              ${test.percentage}%
                                            </div>
                                            <div class="text-xs text-gray-500">${test.correct}/${test.answeredCount || test.total}</div>
                                          </div>
                                          <svg class="w-4 h-4 transform transition-transform ${isTestExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                          </svg>
                                        </div>
                                      </div>
                                    </button>

                                    ${isTestExpanded ? `
                                      <div class="border-t border-gray-700 p-3 bg-gray-800/20">
                                        <div class="space-y-2">
                                          ${[...correctQuestions, ...wrongQuestions].map(({ idx, question, answer }) => {
                                            const isCorrect = answer?.correct;
                                            return `
                                              <div class="bg-${isCorrect ? 'green' : 'red'}-900/10 border border-${isCorrect ? 'green' : 'red'}-500/30 rounded-lg p-2">
                                                <p class="text-xs text-${isCorrect ? 'green' : 'red'}-400 font-semibold mb-1">ë¬¸ì œ ${idx + 1}</p>
                                                <p class="text-xs text-gray-300 mb-2 leading-relaxed">${question.question}</p>
                                                ${answer?.imageUrl ? `
                                                  <div class="mt-2">
                                                    <p class="text-xs text-blue-400 font-semibold mb-1">âœï¸ í•„ê¸°:</p>
                                                    <img src="${answer.imageUrl}" alt="í•„ê¸°" class="w-full rounded border border-gray-700" onerror="this.style.display='none'" />
                                                  </div>
                                                ` : ''}
                                                ${test.teacherNotes?.[idx] ? `
                                                  <div class="mt-2 bg-orange-900/20 border border-orange-500/30 rounded p-2">
                                                    <p class="text-xs text-orange-400 font-semibold mb-1">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</p>
                                                    <p class="text-xs text-gray-300">${test.teacherNotes[idx]}</p>
                                                  </div>
                                                ` : ''}
                                              </div>
                                            `;
                                          }).join('')}
                                        </div>
                                      </div>
                                    ` : ''}
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          </div>
                        ` : ''}
                      </div>
                    `;
                  }).join('');
                })()}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.showStudentRecords = false;
        render();
      });

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
      document.querySelectorAll('.start-wrong-answer-test-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const attemptDate = btn.dataset.attemptDate;
          const round = parseInt(btn.dataset.round) || 1;
          console.log('êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ë²„íŠ¼ í´ë¦­:', attemptDate, 'íšŒì°¨:', round);
          startWrongAnswerTestForStudent(attemptDate, round);
        });
      });

      // í‡´ì› ì²˜ë¦¬ ë²„íŠ¼
      const withdrawBtn = document.getElementById('withdrawBtn');
      if (withdrawBtn) {
        withdrawBtn.addEventListener('click', async () => {
          if (confirm(`${student.studentName} í•™ìƒì„ í‡´ì› ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\n\\ní‡´ì›ìƒìœ¼ë¡œ ì´ë™í•˜ë©°, ë‚˜ì¤‘ì— ì¬ì› ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
            try {
              await db.collection('oral-test-students').doc(student.id).update({
                status: 'withdrawn',
                withdrawnAt: new Date().toISOString()
              });
              alert('í‡´ì› ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
              
              // ìƒíƒœ ì—…ë°ì´íŠ¸
              student.status = 'withdrawn';
              state.studentStatusFilter = 'withdrawn';
              state.selectedStudent = null;
              
              // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              await loadAdminData(state.adminName);
              render();
            } catch (error) {
              console.error('í‡´ì› ì²˜ë¦¬ ì˜¤ë¥˜:', error);
              alert('í‡´ì› ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }
        });
      }

      // ì¬ì› ì²˜ë¦¬ ë²„íŠ¼
      const reactivateBtn = document.getElementById('reactivateBtn');
      if (reactivateBtn) {
        reactivateBtn.addEventListener('click', async () => {
          if (confirm(`${student.studentName} í•™ìƒì„ ì¬ì› ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì¬ì›ìƒ ëª©ë¡ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) {
            try {
              await db.collection('oral-test-students').doc(student.id).update({
                status: 'active',
                reactivatedAt: new Date().toISOString()
              });
              alert('ì¬ì› ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
              
              // ìƒíƒœ ì—…ë°ì´íŠ¸
              student.status = 'active';
              state.studentStatusFilter = 'active';
              state.selectedStudent = null;
              
              // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
              await loadAdminData(state.adminName);
              render();
            } catch (error) {
              console.error('ì¬ì› ì²˜ë¦¬ ì˜¤ë¥˜:', error);
              alert('ì¬ì› ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          }
        });
      }

      // ì¹´ë“œ í—¤ë” í´ë¦­ (í™•ì¥/ì¶•ì†Œ)
      document.querySelectorAll('.attempt-card-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const attemptId = btn.dataset.attemptId;
          state.expandedAttempts[attemptId] = !state.expandedAttempts[attemptId];
          render();
        });
      });
    }

    function renderStudentRecordsOnly(app, currentStudentAttempts) {
      console.log('=== renderStudentRecordsOnly í˜¸ì¶œ ===');
      console.log('ë°›ì€ currentStudentAttempts:', currentStudentAttempts);
      console.log('currentStudentAttempts.length:', currentStudentAttempts.length);

      // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
      const sortedAttempts = [...currentStudentAttempts].sort((a, b) =>
        new Date(b.date) - new Date(a.date)
      );

      console.log('ì •ë ¬ í›„ sortedAttempts.length:', sortedAttempts.length);
      console.log('sortedAttempts:', sortedAttempts);

      const hasData = sortedAttempts && sortedAttempts.length > 0;
      console.log('ğŸ” hasData ê²€ì‚¬:', hasData, '(sortedAttempts.length:', sortedAttempts.length, ')');

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('user', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${state.studentName}</h2>
                    <p class="text-sm text-gray-400">í•™ìŠµ ê¸°ë¡</p>
                  </div>
                </div>
                <button id="logoutBtn" class="px-5 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95">
                  ë¡œê·¸ì•„ì›ƒ
                </button>
              </div>
            </div>

            ${!hasData ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800 mb-6">
                ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium mb-2">ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                <p class="text-sm text-gray-500">ì„ ìƒë‹˜ì´ êµ¬ë‘í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ ê¸°ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
              </div>
            ` : `
              <div class="space-y-6">
                ${(() => {
                  // êµ¬ë‘í…ŒìŠ¤íŠ¸ì™€ ì¬ì‹œí—˜ì„ ë¶„ë¦¬
                  // ë˜‘ë˜‘í•œ í•„í„°ë§: isWrongAnswerTestê°€ trueì—¬ë„ ì‹¤ì œ ì¬ì‹œí—˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ í…ŒìŠ¤íŠ¸ë¡œ ê°„ì£¼
                  const regularTests = sortedAttempts.filter(a => {
                    // ëª…ì‹œì ìœ¼ë¡œ falseë©´ ì¼ë°˜ í…ŒìŠ¤íŠ¸
                    if (!a.isWrongAnswerTest) return true;

                    // isWrongAnswerTestê°€ trueì§€ë§Œ wrongAnswerAttemptIdê°€ ì—†ìœ¼ë©´ ì˜ëª» ë¶„ë¥˜ëœ ì¼ë°˜ í…ŒìŠ¤íŠ¸
                    const hasWrongAnswerData = a.wrongAnswerAttemptId;

                    // ì¬ì‹œí—˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¼ë°˜ í…ŒìŠ¤íŠ¸ë¡œ ì·¨ê¸‰
                    return !hasWrongAnswerData;
                  });

                  const wrongAnswerTests = sortedAttempts.filter(a => {
                    // isWrongAnswerTestì´ê³  wrongAnswerAttemptIdê°€ ìˆìœ¼ë©´ ì¬ì‹œí—˜
                    return a.isWrongAnswerTest && a.wrongAnswerAttemptId;
                  });

                  console.log('ğŸ” ë˜‘ë˜‘í•œ í•„í„°ë§ ê²°ê³¼:', {
                    sortedAttempts_length: sortedAttempts.length,
                    regularTests_length: regularTests.length,
                    wrongAnswerTests_length: wrongAnswerTests.length
                  });

                  if (sortedAttempts[0]) {
                    console.log('sortedAttempts[0] ë¶„ì„:', {
                      isWrongAnswerTest: sortedAttempts[0].isWrongAnswerTest,
                      hasWrongAnswerAttemptId: !!sortedAttempts[0].wrongAnswerAttemptId,
                      wrongAnswerQuestionsLength: sortedAttempts[0].wrongAnswerQuestions?.length || 0
                    });
                  }

                  if (regularTests.length === 0) {
                    console.log('âŒ regularTestsê°€ ì—¬ì „íˆ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
                    console.log('âš ï¸ ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤ (í•„í„°ë§ ì—†ìŒ)');

                    // ì¼ë°˜ í…ŒìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´ ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ ê·¸ëƒ¥ í‘œì‹œ
                    return sortedAttempts.map((test, idx) => {
                      const testId = `all-test-${idx}`;
                      const isExpanded = state.expandedAttempts[testId];
                      const category = categories.find(c => c.id === test.categoryId);
                      const theme = category?.chapters.find(t => t.id === test.themeId);

                      if (!theme) return '';

                      const testType = test.isWrongAnswerTest ? `ì¬ì‹œí—˜ ${test.retestRound || 1}íšŒì°¨` : 'êµ¬ë‘í…ŒìŠ¤íŠ¸';
                      const testColor = test.isWrongAnswerTest ? 'purple' : 'orange';

                      return `
                        <div class="bg-gray-900 rounded-2xl border border-gray-800 shadow-xl overflow-hidden">
                          <button
                            class="attempt-card-header w-full text-left p-4 hover:bg-gray-800/50 transition-all"
                            data-attempt-id="${testId}"
                          >
                            <div class="flex items-center justify-between mb-3">
                              <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                  <h3 class="text-sm font-bold text-white">${test.themeName}</h3>
                                  <span class="text-xs px-2 py-1 rounded bg-${testColor}-500/20 text-${testColor}-400">
                                    ${testType}
                                  </span>
                                </div>
                                <p class="text-xs text-gray-500">${test.date}</p>
                              </div>
                              <div class="text-2xl font-bold ${test.percentage === 100 ? 'text-green-400' : test.percentage >= 80 ? 'text-orange-400' : 'text-red-400'}">
                                ${test.percentage}%
                              </div>
                            </div>

                            <div class="grid grid-cols-4 gap-2 pt-3 border-t border-gray-800">
                              <div class="text-center">
                                <div class="text-base font-bold text-green-400">${test.correct}</div>
                                <div class="text-xs text-gray-500">ë§í˜</div>
                              </div>
                              <div class="text-center">
                                <div class="text-base font-bold text-red-400">${(test.answeredCount || test.total) - test.correct}</div>
                                <div class="text-xs text-gray-500">í‹€ë¦¼</div>
                              </div>
                              <div class="text-center">
                                <div class="text-base font-bold text-blue-400">${(() => {
                                  const totalMs = test.totalTime || 0;
                                  const mins = Math.floor(totalMs / 60000);
                                  const secs = Math.floor((totalMs % 60000) / 1000);
                                  return mins > 0 ? `${mins}ë¶„` : `${secs}ì´ˆ`;
                                })()}</div>
                                <div class="text-xs text-gray-500">ì´ ì‹œê°„</div>
                              </div>
                              <div class="text-center flex items-center justify-center">
                                <svg class="w-4 h-4 transform transition-transform ${isExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                              </div>
                            </div>
                          </button>
                        </div>
                      `;
                    }).join('');
                  } else {
                    console.log('âœ… regularTestsì—', regularTests.length, 'ê°œì˜ í…ŒìŠ¤íŠ¸ê°€ ìˆìŠµë‹ˆë‹¤');
                  }

                  // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™” (YYYY. MM. DD í˜•ì‹ìœ¼ë¡œ)
                  const groupedByDate = {};
                  regularTests.forEach(test => {
                    // "2025. 12. 17. ì˜¤ì „ 1:14:10" -> "2025. 12. 17" ì¶”ì¶œ
                    const dateParts = test.date.split(' ');
                    const dateOnly = dateParts[0] + ' ' + dateParts[1] + ' ' + dateParts[2].replace('.', '');

                    if (!groupedByDate[dateOnly]) {
                      groupedByDate[dateOnly] = [];
                    }
                    groupedByDate[dateOnly].push(test);
                  });

                  // ë‚ ì§œ í‚¤ë“¤ì„ ë°°ì—´ë¡œ ë³€í™˜í•˜ê³  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ìµœì‹  ë‚ ì§œê°€ ë¨¼ì €)
                  const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                    const parseDate = (dateStr) => {
                      const parts = dateStr.split(' ').map(p => parseInt(p.replace('.', '')));
                      return new Date(parts[0], parts[1] - 1, parts[2]);
                    };
                    return parseDate(b) - parseDate(a);
                  });

                  // ë‚ ì§œë³„ë¡œ ë Œë”ë§
                  return sortedDates.map(dateKey => {
                    const testsForDate = groupedByDate[dateKey];

                    return `
                      <div class="mb-8">
                        <h2 class="text-xl font-bold text-white mb-4 border-b border-gray-700 pb-2">${dateKey}</h2>
                        <div class="space-y-4">
                          ${testsForDate.map((regularTest, localIdx) => {
                            // ì „ì²´ ë°°ì—´ì—ì„œì˜ ì¸ë±ìŠ¤ ê³„ì‚° (ID ì¶©ëŒ ë°©ì§€)
                            const idx = regularTests.findIndex(t => t === regularTest);
                    // í•´ë‹¹ êµ¬ë‘í…ŒìŠ¤íŠ¸ì˜ ì¬ì‹œí—˜ 1íšŒì°¨, 2íšŒì°¨ ëª¨ë‘ ì°¾ê¸°
                    const wrongTests = wrongAnswerTests.filter(w => w.wrongAnswerAttemptId === regularTest.date);
                    const wrongTest1 = wrongTests.find(w => w.retestRound === 1);
                    const wrongTest2 = wrongTests.find(w => w.retestRound === 2);
                    const hasRetests = wrongTests.length > 0;

                    // ì¬ì‹œí—˜ ìƒíƒœ ê³„ì‚°
                    let retestStatus = null;
                    let retestStatusColor = '';
                    let retestStatusText = '';

                    if (wrongTest1 && wrongTest1.percentage === 100) {
                      retestStatus = 'pass1';
                      retestStatusColor = 'bg-green-500/30 text-green-400';
                      retestStatusText = 'ì¬ì‹œí—˜ 1íšŒì°¨ í†µê³¼';
                    } else if (wrongTest1 && wrongTest1.percentage < 100 && !wrongTest2) {
                      retestStatus = 'fail1';
                      retestStatusColor = 'bg-red-500/30 text-red-400';
                      retestStatusText = 'ì¬ì‹œí—˜ 1íšŒì°¨ ë¶ˆí†µê³¼';
                    } else if (wrongTest2 && wrongTest2.percentage === 100) {
                      retestStatus = 'pass2';
                      retestStatusColor = 'bg-green-500/30 text-green-400';
                      retestStatusText = 'ì¬ì‹œí—˜ 2íšŒì°¨ í†µê³¼';
                    } else if (wrongTest2 && wrongTest2.percentage < 100) {
                      retestStatus = 'fail';
                      retestStatusColor = 'bg-red-500/30 text-red-400';
                      retestStatusText = 'ì¬ì‹œí—˜ ë¶ˆí†µê³¼';
                    }

                    const category = categories.find(c => c.id === regularTest.categoryId);
                    const theme = category?.chapters.find(t => t.id === regularTest.themeId);

                    const regularAttemptId = `regular-${idx}`;
                    const retestsAttemptId = `retests-${idx}`;
                    const isRegularExpanded = state.expandedAttempts[regularAttemptId];
                    const isRetestsExpanded = state.expandedAttempts[retestsAttemptId];

                    // êµ¬ë‘í…ŒìŠ¤íŠ¸ì˜ ë§ì€/í‹€ë¦° ë¬¸ì œ ë¶„ë¥˜
                    const regularCorrectQuestions = [];
                    const regularWrongQuestions = [];
                    const regularAnsweredQuestions = regularTest.answeredQuestions || Object.keys(regularTest.answers || {}).map(Number);

                    regularAnsweredQuestions.forEach(qIdx => {
                      const answer = regularTest.answers?.[qIdx];
                      const question = theme?.questions[qIdx];
                      if (question) {
                        if (answer?.correct) {
                          regularCorrectQuestions.push({ idx: qIdx, question, answer });
                        } else {
                          regularWrongQuestions.push({ idx: qIdx, question, answer });
                        }
                      }
                    });

                    // ì¬ì‹œí—˜ 1íšŒì°¨ì˜ ë§ì€/í‹€ë¦° ë¬¸ì œ ë¶„ë¥˜
                    let wrongCorrectQuestions1 = [];
                    let wrongWrongQuestions1 = [];
                    if (wrongTest1) {
                      const wrongAnsweredQuestions = wrongTest1.answeredQuestions || Object.keys(wrongTest1.answers || {}).map(Number);
                      wrongAnsweredQuestions.forEach(qIdx => {
                        const answer = wrongTest1.answers?.[qIdx];
                        const question = theme?.questions[qIdx];
                        if (question) {
                          if (answer?.correct) {
                            wrongCorrectQuestions1.push({ idx: qIdx, question, answer });
                          } else {
                            wrongWrongQuestions1.push({ idx: qIdx, question, answer });
                          }
                        }
                      });
                    }

                    // ì¬ì‹œí—˜ 2íšŒì°¨ì˜ ë§ì€/í‹€ë¦° ë¬¸ì œ ë¶„ë¥˜
                    let wrongCorrectQuestions2 = [];
                    let wrongWrongQuestions2 = [];
                    if (wrongTest2) {
                      const wrongAnsweredQuestions = wrongTest2.answeredQuestions || Object.keys(wrongTest2.answers || {}).map(Number);
                      wrongAnsweredQuestions.forEach(qIdx => {
                        const answer = wrongTest2.answers?.[qIdx];
                        const question = theme?.questions[qIdx];
                        if (question) {
                          if (answer?.correct) {
                            wrongCorrectQuestions2.push({ idx: qIdx, question, answer });
                          } else {
                            wrongWrongQuestions2.push({ idx: qIdx, question, answer });
                          }
                        }
                      });
                    }

                    // ë‘ ì¹´ë“œë¥¼ ê·¸ë¦¬ë“œë¡œ ë°°ì¹˜
                    return `
                      <div class="grid md:grid-cols-2 gap-4">
                        <!-- êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¹´ë“œ -->
                        <div class="bg-gray-900 rounded-2xl border border-gray-800 shadow-xl overflow-hidden">
                          <button
                            class="attempt-card-header w-full text-left p-4 hover:bg-gray-800/50 transition-all"
                            data-attempt-id="${regularAttemptId}"
                          >
                            <div class="flex items-center justify-between mb-3">
                              <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                  <h3 class="text-base font-bold text-white">${regularTest.themeName}</h3>
                                  <span class="text-xs px-2 py-1 rounded ${regularTest.percentage >= 80 ? 'bg-green-500/30 text-green-400' : 'bg-red-500/30 text-red-400'} font-bold">
                                    ${regularTest.percentage >= 80 ? 'êµ¬ë‘í…ŒìŠ¤íŠ¸ í†µê³¼' : 'êµ¬ë‘í…ŒìŠ¤íŠ¸ ë¶ˆí†µê³¼'}
                                  </span>
                                </div>
                                <p class="text-xs text-gray-500">${regularTest.date.split(' ').slice(3).join(' ')}</p>
                              </div>
                              <div class="text-2xl font-bold ${regularTest.percentage === 100 ? 'text-green-400' : regularTest.percentage >= 80 ? 'text-orange-400' : 'text-red-400'}">
                                ${regularTest.percentage}%
                              </div>
                            </div>

                            <div class="grid grid-cols-4 gap-2 pt-3 border-t border-gray-800">
                              <div class="text-center">
                                <div class="text-base font-bold text-green-400">${regularTest.correct}</div>
                                <div class="text-xs text-gray-500">ë§í˜</div>
                              </div>
                              <div class="text-center">
                                <div class="text-base font-bold text-red-400">${(regularTest.answeredCount || regularTest.total) - regularTest.correct}</div>
                                <div class="text-xs text-gray-500">í‹€ë¦¼</div>
                              </div>
                              <div class="text-center">
                                <div class="text-base font-bold text-blue-400">${(() => {
                                  const totalMs = regularTest.totalTime || 0;
                                  const mins = Math.floor(totalMs / 60000);
                                  const secs = Math.floor((totalMs % 60000) / 1000);
                                  return mins > 0 ? `${mins}ë¶„` : `${secs}ì´ˆ`;
                                })()}</div>
                                <div class="text-xs text-gray-500">ì´ ì‹œê°„</div>
                              </div>
                              <div class="text-center flex items-center justify-center">
                                <svg class="w-4 h-4 transform transition-transform ${isRegularExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                </svg>
                              </div>
                            </div>
                          </button>

                          ${isRegularExpanded && theme ? `
                            <div class="border-t border-gray-800 p-4 bg-gray-800/30">
                              <div class="space-y-3">
                                ${[...regularCorrectQuestions, ...regularWrongQuestions].map(({ idx, question, answer }) => {
                                  const isCorrect = answer?.correct;
                                  return `
                                    <div class="bg-${isCorrect ? 'green' : 'red'}-900/10 border border-${isCorrect ? 'green' : 'red'}-500/30 rounded-lg p-3">
                                      <p class="text-xs text-${isCorrect ? 'green' : 'red'}-400 font-semibold mb-1">ë¬¸ì œ ${idx + 1}</p>
                                      <p class="text-xs text-gray-300 mb-2 leading-relaxed">${question.question}</p>
                                      ${answer?.imageUrl ? `
                                        <div class="mt-2">
                                          <p class="text-xs text-blue-400 font-semibold mb-1">âœï¸ í•„ê¸°:</p>
                                          <img src="${answer.imageUrl}" alt="í•„ê¸°" class="w-full rounded border border-gray-700" onerror="this.style.display='none'" />
                                        </div>
                                      ` : ''}
                                      ${regularTest.teacherNotes?.[idx] ? `
                                        <div class="mt-2 bg-orange-900/20 border border-orange-500/30 rounded p-2">
                                          <p class="text-xs text-orange-400 font-semibold mb-1">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</p>
                                          <p class="text-xs text-gray-300">${regularTest.teacherNotes[idx]}</p>
                                        </div>
                                      ` : ''}
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                            </div>
                          ` : ''}
                        </div>

                        <!-- ì¬ì‹œí—˜ ì¹´ë“œ (1íšŒì°¨ì™€ 2íšŒì°¨ë¥¼ ë¬¶ì–´ì„œ í‘œì‹œ) -->
                        ${hasRetests ? `
                          <div class="bg-gray-900 rounded-2xl border border-gray-800 shadow-xl overflow-hidden">
                            <button
                              class="attempt-card-header w-full text-left p-4 hover:bg-gray-800/50 transition-all"
                              data-attempt-id="${retestsAttemptId}"
                            >
                              <div class="flex items-center justify-between mb-3">
                                <div class="flex-1">
                                  <div class="flex items-center gap-2 mb-1">
                                    <h3 class="text-base font-bold text-white">${regularTest.themeName}</h3>
                                    ${retestStatusText ? `
                                      <span class="text-xs px-2 py-1 rounded font-bold ${retestStatusColor}">
                                        ${retestStatusText}
                                      </span>
                                    ` : ''}
                                  </div>
                                  <p class="text-xs text-gray-500">
                                    ${wrongTest1 ? wrongTest1.date.split(' ').slice(3).join(' ') : ''}${wrongTest1 && wrongTest2 ? ', ' : ''}${wrongTest2 ? wrongTest2.date.split(' ').slice(3).join(' ') : ''}
                                  </p>
                                </div>
                                <div class="text-center flex items-center justify-center">
                                  <svg class="w-4 h-4 transform transition-transform ${isRetestsExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                  </svg>
                                </div>
                              </div>
                            </button>

                            ${isRetestsExpanded && theme ? `
                              <div class="border-t border-gray-800 p-4 bg-gray-800/30 space-y-4">
                                <!-- ì¬ì‹œí—˜ 1íšŒì°¨ -->
                                ${wrongTest1 ? `
                                  <div class="bg-purple-900/10 rounded-xl border border-purple-500/30 p-3">
                                    <div class="flex items-center justify-between mb-3">
                                      <div class="flex items-center gap-2">
                                        <span class="text-xs px-2 py-1 rounded bg-purple-500/30 text-purple-300 font-bold">
                                          ì¬ì‹œí—˜ 1íšŒì°¨
                                        </span>
                                        ${wrongTest1.percentage === 100 ? `
                                          <span class="text-xs px-2 py-1 rounded bg-green-500/30 text-green-400 font-bold">
                                            í†µê³¼
                                          </span>
                                        ` : ''}
                                        <span class="text-xs text-gray-500">${wrongTest1.date}</span>
                                      </div>
                                      <div class="text-xl font-bold ${wrongTest1.percentage === 100 ? 'text-green-400' : wrongTest1.percentage >= 80 ? 'text-purple-400' : 'text-red-400'}">
                                        ${wrongTest1.percentage}%
                                      </div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                      <div class="text-center bg-green-900/20 rounded p-2">
                                        <div class="text-base font-bold text-green-400">${wrongTest1.correct}</div>
                                        <div class="text-xs text-gray-500">ë§í˜</div>
                                      </div>
                                      <div class="text-center bg-red-900/20 rounded p-2">
                                        <div class="text-base font-bold text-red-400">${(wrongTest1.answeredCount || wrongTest1.total) - wrongTest1.correct}</div>
                                        <div class="text-xs text-gray-500">í‹€ë¦¼</div>
                                      </div>
                                      <div class="text-center bg-blue-900/20 rounded p-2">
                                        <div class="text-base font-bold text-blue-400">${(() => {
                                          const totalMs = wrongTest1.totalTime || 0;
                                          const mins = Math.floor(totalMs / 60000);
                                          const secs = Math.floor((totalMs % 60000) / 1000);
                                          return mins > 0 ? `${mins}ë¶„` : `${secs}ì´ˆ`;
                                        })()}</div>
                                        <div class="text-xs text-gray-500">ì´ ì‹œê°„</div>
                                      </div>
                                    </div>

                                    <div class="space-y-3">
                                      ${[...wrongCorrectQuestions1, ...wrongWrongQuestions1].map(({ idx, question, answer }) => {
                                        const isCorrect = answer?.correct;
                                        return `
                                          <div class="bg-${isCorrect ? 'green' : 'red'}-900/10 border border-${isCorrect ? 'green' : 'red'}-500/30 rounded-lg p-3">
                                            <p class="text-xs text-${isCorrect ? 'green' : 'red'}-400 font-semibold mb-1">ë¬¸ì œ ${idx + 1}</p>
                                            <p class="text-xs text-gray-300 mb-2 leading-relaxed">${question.question}</p>
                                            ${answer?.imageUrl ? `
                                              <div class="mt-2">
                                                <p class="text-xs text-blue-400 font-semibold mb-1">âœï¸ í•„ê¸°:</p>
                                                <img src="${answer.imageUrl}" alt="í•„ê¸°" class="w-full rounded border border-gray-700" onerror="this.style.display='none'" />
                                              </div>
                                            ` : ''}
                                            ${wrongTest1.teacherNotes?.[idx] ? `
                                              <div class="mt-2 bg-orange-900/20 border border-orange-500/30 rounded p-2">
                                                <p class="text-xs text-orange-400 font-semibold mb-1">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</p>
                                                <p class="text-xs text-gray-300">${wrongTest1.teacherNotes[idx]}</p>
                                              </div>
                                            ` : ''}
                                          </div>
                                        `;
                                      }).join('')}
                                    </div>
                                  </div>
                                ` : ''}

                                <!-- ì¬ì‹œí—˜ 2íšŒì°¨ -->
                                ${wrongTest2 ? `
                                  <div class="bg-purple-900/10 rounded-xl border border-purple-500/30 p-3">
                                    <div class="flex items-center justify-between mb-3">
                                      <div class="flex items-center gap-2">
                                        <span class="text-xs px-2 py-1 rounded bg-purple-500/30 text-purple-300 font-bold">
                                          ì¬ì‹œí—˜ 2íšŒì°¨
                                        </span>
                                        ${wrongTest2.percentage === 100 ? `
                                          <span class="text-xs px-2 py-1 rounded bg-green-500/30 text-green-400 font-bold">
                                            í†µê³¼
                                          </span>
                                        ` : `
                                          <span class="text-xs px-2 py-1 rounded bg-red-500/30 text-red-400 font-bold">
                                            ë¶ˆí†µê³¼
                                          </span>
                                        `}
                                        <span class="text-xs text-gray-500">${wrongTest2.date}</span>
                                      </div>
                                      <div class="text-xl font-bold ${wrongTest2.percentage === 100 ? 'text-green-400' : wrongTest2.percentage >= 80 ? 'text-purple-400' : 'text-red-400'}">
                                        ${wrongTest2.percentage}%
                                      </div>
                                    </div>

                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                      <div class="text-center bg-green-900/20 rounded p-2">
                                        <div class="text-base font-bold text-green-400">${wrongTest2.correct}</div>
                                        <div class="text-xs text-gray-500">ë§í˜</div>
                                      </div>
                                      <div class="text-center bg-red-900/20 rounded p-2">
                                        <div class="text-base font-bold text-red-400">${(wrongTest2.answeredCount || wrongTest2.total) - wrongTest2.correct}</div>
                                        <div class="text-xs text-gray-500">í‹€ë¦¼</div>
                                      </div>
                                      <div class="text-center bg-blue-900/20 rounded p-2">
                                        <div class="text-base font-bold text-blue-400">${(() => {
                                          const totalMs = wrongTest2.totalTime || 0;
                                          const mins = Math.floor(totalMs / 60000);
                                          const secs = Math.floor((totalMs % 60000) / 1000);
                                          return mins > 0 ? `${mins}ë¶„` : `${secs}ì´ˆ`;
                                        })()}</div>
                                        <div class="text-xs text-gray-500">ì´ ì‹œê°„</div>
                                      </div>
                                    </div>

                                    <div class="space-y-3">
                                      ${[...wrongCorrectQuestions2, ...wrongWrongQuestions2].map(({ idx, question, answer }) => {
                                        const isCorrect = answer?.correct;
                                        return `
                                          <div class="bg-${isCorrect ? 'green' : 'red'}-900/10 border border-${isCorrect ? 'green' : 'red'}-500/30 rounded-lg p-3">
                                            <p class="text-xs text-${isCorrect ? 'green' : 'red'}-400 font-semibold mb-1">ë¬¸ì œ ${idx + 1}</p>
                                            <p class="text-xs text-gray-300 mb-2 leading-relaxed">${question.question}</p>
                                            ${answer?.imageUrl ? `
                                              <div class="mt-2">
                                                <p class="text-xs text-blue-400 font-semibold mb-1">âœï¸ í•„ê¸°:</p>
                                                <img src="${answer.imageUrl}" alt="í•„ê¸°" class="w-full rounded border border-gray-700" onerror="this.style.display='none'" />
                                              </div>
                                            ` : ''}
                                            ${wrongTest2.teacherNotes?.[idx] ? `
                                              <div class="mt-2 bg-orange-900/20 border border-orange-500/30 rounded p-2">
                                                <p class="text-xs text-orange-400 font-semibold mb-1">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</p>
                                                <p class="text-xs text-gray-300">${wrongTest2.teacherNotes[idx]}</p>
                                              </div>
                                            ` : ''}
                                          </div>
                                        `;
                                      }).join('')}
                                    </div>
                                  </div>
                                ` : ''}
                              </div>
                            ` : ''}
                          </div>
                        ` : `
                          <div class="bg-gray-900/30 rounded-2xl border border-dashed border-gray-700 p-8 flex items-center justify-center">
                            <p class="text-gray-600 text-sm text-center">
                              ì¬ì‹œí—˜ ë¯¸ì§„í–‰
                            </p>
                          </div>
                        `}
                      </div>
                    `;
                          }).join('')}
                        </div>
                      </div>
                    `;
                  }).join('');
                })()}
              </div>
            `}

            <div class="mt-6 bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
              <p class="text-blue-400 text-sm font-medium text-center">
                ${icon('info', 'inline mr-2', 18)}êµ¬ë‘í…ŒìŠ¤íŠ¸ëŠ” ì„ ìƒë‹˜ì´ ì§„í–‰í•©ë‹ˆë‹¤
              </p>
              <p class="text-xs text-gray-400 mt-1 text-center">ì„ ìƒë‹˜ê»˜ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ê¸°ë¡ì´ ë‚¨ìŠµë‹ˆë‹¤.</p>
              <button
                id="refreshDataBtn"
                class="mt-3 w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm"
              >
                ${icon('refreshCw', 'inline mr-2', 18)}ìµœì‹  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
              </button>
            </div>
          </div>
        </div>
      `;

      // ìµœì‹  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼
      const refreshBtn = document.getElementById('refreshDataBtn');
      console.log('ğŸ”µ refreshDataBtn ìš”ì†Œ:', refreshBtn ? 'ì¡´ì¬í•¨' : 'âŒ ì—†ìŒ!');

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          console.log('\nğŸ”„ ===== ìµœì‹  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ í´ë¦­ =====');
          console.log('í´ë¦­ ì‹œê°:', new Date().toLocaleTimeString());
          console.log('í˜„ì¬ state.uid:', state.uid);
          console.log('í˜„ì¬ state.studentName:', state.studentName);
          console.log('ë¶ˆëŸ¬ì˜¤ê¸° ì „ attempts ìˆ˜:', state.allStudentData[state.studentName]?.attempts?.length || 0);
          console.log('ë¶ˆëŸ¬ì˜¤ê¸° ì „ state.isWrongAnswerTest:', state.isWrongAnswerTest);

          const btn = document.getElementById('refreshDataBtn');
          btn.disabled = true;
          btn.innerHTML = `${icon('refreshCw', 'inline mr-2 animate-spin', 18)}ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;

          console.log('â³ loadData() í˜¸ì¶œ ì‹œì‘...');
          await loadData(state.uid);
          console.log('âœ… loadData() ì™„ë£Œ');

          console.log('ë¶ˆëŸ¬ì˜¨ í›„ attempts ìˆ˜:', state.allStudentData[state.studentName]?.attempts?.length || 0);
          console.log('ë¶ˆëŸ¬ì˜¨ í›„ state.isWrongAnswerTest:', state.isWrongAnswerTest);
          console.log('ë¶ˆëŸ¬ì˜¨ ë°ì´í„°:', state.allStudentData[state.studentName]);

          console.log('ğŸ”„ render() í˜¸ì¶œ...');
          render();
          console.log('===== ìµœì‹  ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ =====\n');
        });
      } else {
        console.error('âŒ refreshDataBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
      }

      // DOMì— ì‹¤ì œë¡œ ë Œë”ë§ëœ ë‚´ìš© í™•ì¸
      setTimeout(() => {
        const appElement = document.getElementById('app');
        const hasNoDataMessage = appElement.innerHTML.includes('ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤');
        const hasTestData = appElement.innerHTML.includes('ì´') && appElement.innerHTML.includes('ê°œ ë¬¸ì œ');
        console.log('ğŸ“‹ DOM í™•ì¸:', {
          hasNoDataMessage,
          hasTestData,
          refreshBtnExists: !!document.getElementById('refreshDataBtn')
        });
      }, 50);

      // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
      document.getElementById('logoutBtn').addEventListener('click', () => {
        state.isLoggedIn = false;
        state.userType = null;
        state.studentName = '';
        state.phone = '';
        state.teacherName = '';
        state.uid = '';
        state.selectedCategory = null;
        state.currentTheme = null;
        state.currentQuestion = 0;
        state.answers = {};
        state.allStudentData = {};
        state.expandedAttempts = {};
        render();
      });

      // ì¹´ë“œ í—¤ë” í´ë¦­ (í™•ì¥/ì¶•ì†Œ)
      document.querySelectorAll('.attempt-card-header').forEach(btn => {
        btn.addEventListener('click', () => {
          const attemptId = btn.dataset.attemptId;
          state.expandedAttempts[attemptId] = !state.expandedAttempts[attemptId];
          render();
        });
      });
    }

    function renderMainScreen() {
      const app = document.getElementById('app');
      console.log('=== renderMainScreen í˜¸ì¶œ ===');
      console.log('state.studentName:', state.studentName);
      console.log('state.allStudentData í‚¤ë“¤:', Object.keys(state.allStudentData));
      console.log('state.allStudentData[state.studentName]:', state.allStudentData[state.studentName]);

      const currentStudentAttempts = state.allStudentData[state.studentName]?.attempts || [];
      console.log('currentStudentAttempts ê¸¸ì´:', currentStudentAttempts.length);

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ëª¨ë“œì¼ ë•ŒëŠ” í€´ì¦ˆ í™”ë©´ í‘œì‹œ
      if (state.isWrongAnswerTest && state.wrongAnswerQuestions.length > 0) {
        renderQuizScreen(app);
      } else {
        // í•™ìƒì€ í•™ìŠµ ê¸°ë¡ë§Œ ë³¼ ìˆ˜ ìˆìŒ (í…ŒìŠ¤íŠ¸ëŠ” ì„ ìƒë‹˜ì´ ì§„í–‰)
        renderStudentRecordsOnly(app, currentStudentAttempts);
      }
    }

    function renderAdminCategorySelection(app) {
      const student = state.selectedStudent;

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                  ${icon('user', 'text-white')}
                </div>
                <div class="flex-1">
                  <h2 class="text-xl font-bold text-white">${student.studentName}</h2>
                  <p class="text-sm text-gray-400 mt-1">${state.adminName} ì„ ìƒë‹˜</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button id="recordBtn" class="flex items-center px-5 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95">
                  ${icon('barChart', 'mr-2', 18)}í•™ìŠµ ê¸°ë¡ ë³´ê¸°
                </button>
                <button id="backBtn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm">
                  ë’¤ë¡œ ê°€ê¸°
                </button>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              ${categories.map(category => `
                <button
                  data-cat="${category.id}"
                  class="cat-btn bg-gray-900 rounded-2xl p-6 border shadow-xl text-left transition-all transform ${
                    category.chapters.length > 0
                      ? 'border-gray-800 hover:shadow-orange-500/20 hover:border-orange-500/50 hover:scale-105 active:scale-95'
                      : 'border-gray-800 opacity-50 cursor-not-allowed'
                  }"
                  ${category.chapters.length === 0 ? 'disabled' : ''}
                >
                  <h3 class="text-base font-bold text-white mb-2">${category.name}</h3>
                  <p class="text-xs text-gray-500 font-semibold">
                    ${category.chapters.length > 0 ? `${category.chapters.length}ê°œì˜ í…Œë§ˆ` : 'ì¤€ë¹„ ì¤‘'}
                  </p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('recordBtn').addEventListener('click', () => {
        state.showStudentRecords = true;
        render();
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        state.selectedStudent = null;
        state.showStudentRecords = false;
        render();
      });

      document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = parseInt(btn.dataset.cat);
          const category = categories.find(c => c.id === catId);
          if (category.chapters.length > 0) {
            state.selectedCategory = catId;
            render();
          }
        });
      });
    }

    function renderCategorySelection(app) {
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                  ${icon('user', 'text-white')}
                </div>
                <h2 class="text-xl font-bold text-white">${state.studentName}</h2>
              </div>
              <div class="flex gap-2">
                <button id="recordBtn" class="flex items-center px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  ${icon('barChart', 'mr-2', 18)}í•™ìŠµ ê¸°ë¡
                </button>
                <button id="logoutBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-bold text-white transition-all transform hover:scale-105 active:scale-95 text-sm">
                  ë¡œê·¸ì•„ì›ƒ
                </button>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              ${categories.map(category => `
                <button
                  data-cat="${category.id}"
                  class="cat-btn bg-gray-900 rounded-2xl p-6 border shadow-xl text-left transition-all transform ${
                    category.chapters.length > 0
                      ? 'border-gray-800 hover:shadow-orange-500/20 hover:border-orange-500/50 hover:scale-105 active:scale-95'
                      : 'border-gray-800 opacity-50 cursor-not-allowed'
                  }"
                  ${category.chapters.length === 0 ? 'disabled' : ''}
                >
                  <h3 class="text-base font-bold text-white mb-2">${category.name}</h3>
                  <p class="text-xs text-gray-500 font-semibold">
                    ${category.chapters.length > 0 ? `${category.chapters.length}ê°œì˜ í…Œë§ˆ` : 'ì¤€ë¹„ ì¤‘'}
                  </p>
                </button>
              `).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('recordBtn').addEventListener('click', () => {
        state.showResults = true;
        state.recordSelectedCategory = null; // Chapter ì„ íƒ í™”ë©´ì„ ë¨¼ì € ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì´ˆê¸°í™”
        render();
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          logout();
        }
      });

      document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const catId = parseInt(btn.dataset.cat);
          const category = categories.find(c => c.id === catId);
          if (category.chapters.length > 0) {
            state.selectedCategory = catId;
            render();
          }
        });
      });
    }

    function renderThemeSelection(app) {
      const category = categories.find(c => c.id === state.selectedCategory);
      
      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="mb-4">
              <button id="backBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}ì±•í„° ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-8 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between mb-4">
                <div>
                  <h2 class="text-xl font-bold text-white">${category.name}</h2>
                  <p class="text-sm text-gray-400 mt-1 font-medium">í…Œë§ˆ ì„ íƒ</p>
                </div>
                <button id="resultsBtn" class="flex items-center px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  ${icon('barChart', 'mr-2', 18)}í•™ìŠµ ê¸°ë¡
                </button>
              </div>
              
              ${category.chapterInfo ? `
                <div class="mt-4 pt-4 border-t border-gray-700">
                  <div class="grid grid-cols-2 gap-3">
                    ${category.chapterInfo.map(info => `
                      <div class="bg-gray-800/50 rounded-lg p-3 border border-gray-700">
                        <div class="flex items-baseline gap-2 mb-1">
                          <span class="text-orange-400 font-bold text-xs">${info.partName}</span>
                          <span class="text-gray-300 text-xs font-medium">${info.description}</span>
                        </div>
                        <span class="text-gray-500 text-xs">${info.range}</span>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>

            <div class="grid md:grid-cols-2 gap-4">
              ${category.chapters.map(theme => {
                const status = getThemeStatus(state.selectedCategory, theme.id);
                const locked = isLocked(state.selectedCategory, theme.id);
                const remainingSeconds = getRemainingTime(state.selectedCategory, theme.id);
                const minutes = Math.floor(remainingSeconds / 60);
                const seconds = remainingSeconds % 60;
                const isCompleted = status.status === 'completed';

                return `
                  <div class="bg-gray-900 rounded-2xl p-6 shadow-xl transition-all relative ${
                    isCompleted 
                      ? 'border-2 border-green-500/50 shadow-green-500/20' 
                      : 'border border-gray-800 hover:shadow-orange-500/20 hover:border-orange-500/50'
                  }">
                    ${isCompleted ? `
                      <div class="absolute top-4 right-4 flex items-center justify-center" style="width: 28px; height: 28px;">
                        <svg style="width:28px;height:28px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-500">
                          <circle cx="12" cy="8" r="7"/>
                          <path d="M8.21 13.89 7 23l5-3 5 3-1.21-9.12"/>
                        </svg>
                      </div>
                    ` : ''}
                    
                    <div class="flex items-start justify-between mb-4">
                      <h3 class="text-base font-bold text-white flex-1 pr-8">${theme.name}</h3>
                    </div>
                    
                    <p class="text-xs text-gray-500 mb-4 font-semibold">${theme.questions.length}ê°œ ë¬¸ì œ</p>
                    
                    ${status.lastAttempt ? `
                      <div class="mb-4 p-4 bg-gray-800/50 rounded-xl border border-gray-700">
                        <p class="text-xs text-gray-500 font-semibold mb-1">ìµœê·¼ ì‹œë„</p>
                        <p class="text-lg font-bold text-orange-400">
                          ${status.lastAttempt.percentage}% <span class="text-sm text-gray-500">(${status.lastAttempt.correct}/${status.lastAttempt.total})</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">ì‹œë„ íšŸìˆ˜: ${status.attemptCount}íšŒ</p>
                      </div>
                    ` : ''}

                    ${isCompleted ? `
                      <div class="space-y-2">
                        <div class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 rounded-xl font-bold text-white text-center flex items-center justify-center text-sm shadow-lg shadow-green-500/30">
                          ${icon('checkCircle', 'mr-2', 18)}í€´ì¦ˆ ì™„ë£Œ
                        </div>
                        <button data-theme="${theme.id}" class="start-btn w-full py-2 bg-gray-800 hover:bg-gray-700 rounded-xl font-semibold text-white transition-all text-xs border border-gray-700 transform hover:scale-105 active:scale-95">
                          ë‹¤ì‹œ ë„ì „í•˜ê¸°
                        </button>
                      </div>
                    ` : locked ? `
                      <div class="space-y-3">
                        <div class="w-full py-3 bg-gray-800/50 rounded-xl font-bold text-gray-400 text-center border border-gray-700 cursor-not-allowed flex items-center justify-center text-sm">
                          ${icon('lock', 'mr-2', 16)}${icon('clock', 'mr-1', 16)}<span data-lock-timer="${theme.id}">${minutes}:${seconds.toString().padStart(2, '0')} í›„ ì¬ì‹œí—˜ ê°€ëŠ¥</span>
                        </div>
                        <button data-review="${theme.id}" class="review-btn w-full py-3 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transform hover:scale-105 active:scale-95 flex items-center justify-center">
                          ${icon('bookOpen', 'mr-2', 18)}íŒíŠ¸ ë³µìŠµí•˜ê¸°
                        </button>
                      </div>
                    ` : status.status === 'retry' ? `
                      <button data-theme="${theme.id}" class="start-btn w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95">
                        í€´ì¦ˆ ë‹¤ì‹œ ë„ì „í•˜ê¸°
                      </button>
                    ` : `
                      <button data-theme="${theme.id}" class="start-btn w-full py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all text-sm shadow-lg shadow-orange-500/30 hover:shadow-orange-500/50 transform hover:scale-105 active:scale-95">
                        í€´ì¦ˆ ì‹œì‘
                      </button>
                    `}
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.selectedCategory = null;
        render();
      });

      document.getElementById('resultsBtn').addEventListener('click', () => {
        state.showResults = true;
        state.recordSelectedCategory = state.selectedCategory; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ í•™ìŠµ ê¸°ë¡ìš©ìœ¼ë¡œ ì„¤ì •
        render();
      });

      document.querySelectorAll('.start-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          handleStartQuiz(parseInt(btn.dataset.theme));
        });
      });

      document.querySelectorAll('.review-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          state.showResults = true;
          state.selectedCategory = state.selectedCategory;
          render();
        });
      });
    }

    function renderQuizScreen(app) {
      const category = categories.find(c => c.id === state.selectedCategory);
      if (!category || !category.chapters) {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-6"><p class="text-white">ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
        return;
      }

      const theme = category.chapters.find(t => t.id === state.currentTheme);
      if (!theme || !theme.questions) {
        app.innerHTML = `<div class="min-h-screen flex items-center justify-center p-6"><p class="text-white">í…Œë§ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
        return;
      }

      // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ëª¨ë“œì¸ì§€ í™•ì¸
      const isWrongTest = state.isWrongAnswerTest;
      const questions = isWrongTest ? state.wrongAnswerQuestions : theme.questions;
      const themeName = isWrongTest ? `${theme.name} - ì¬ì‹œí—˜ ${state.retestRound || 1}íšŒì°¨` : theme.name;

      const question = questions[state.currentQuestion];
      const answer = state.answers[state.currentQuestion];
      const answeredCount = Object.keys(state.answers).length;
      const correctCount = Object.values(state.answers).filter(a => a.correct).length;
      const incorrectCount = answeredCount - correctCount;
      // ë¶€ë¶„ ì™„ë£Œ í—ˆìš© - ìµœì†Œ 1ë¬¸ì œë§Œ í’€ë©´ ì €ì¥ ê°€ëŠ¥
      const isComplete = answeredCount >= 1;

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-4xl mx-auto">
            <div class="mb-4">
              <button id="backToThemeBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                ${icon('chevronLeft', '', 16)}${isWrongTest ? 'í•™ìŠµ ê¸°ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°' : 'í…Œë§ˆ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°'}
              </button>
            </div>

            <div class="bg-gray-900 rounded-2xl p-5 mb-6 shadow-xl border ${isWrongTest ? 'border-purple-500/30' : 'border-orange-500/30'}">
              <div class="flex items-center justify-between">
                <div>
                  <h2 class="text-base font-bold text-white">${state.studentName}</h2>
                  <p class="text-xs ${isWrongTest ? 'text-purple-400' : 'text-gray-400'} mt-1 font-medium">${themeName}</p>
                </div>
                <div class="text-right">
                  <p class="text-xs text-gray-500 font-semibold">ì§„í–‰ ìƒí™©</p>
                  <p class="text-lg font-bold ${isWrongTest ? 'text-purple-400' : 'text-orange-400'}">${state.currentQuestion + 1} / ${questions.length}</p>
                </div>
              </div>
            </div>

            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-gray-800">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-2xl font-bold text-green-400">${correctCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">ë§íŒ ê°œìˆ˜</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-red-400">${incorrectCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">í‹€ë¦° ê°œìˆ˜</div>
                </div>
                <div>
                  <div class="text-2xl font-bold text-orange-400">${answeredCount}</div>
                  <div class="text-xs text-gray-500 mt-1 font-medium">ë‹µë³€ ì™„ë£Œ</div>
                </div>
              </div>
            </div>

            <div class="bg-gray-900 rounded-2xl p-8 border border-gray-800 shadow-xl mb-6">
              <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                  <span class="inline-block px-3 py-1 bg-orange-500/20 text-orange-400 rounded-lg text-xs font-bold">
                    ë¬¸ì œ ${state.currentQuestion + 1}
                  </span>
                  ${!answer ? `
                    <div class="flex items-center gap-2">
                      <div class="flex items-center gap-2 px-4 py-2 bg-blue-500/20 rounded-lg border border-blue-500/30">
                        <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span id="questionTimer" class="text-lg font-bold text-blue-400">3:00</span>
                      </div>
                      <button
                        id="timerStartBtn"
                        onclick="startQuestionTimer()"
                        class="px-3 py-2 bg-green-500/20 hover:bg-green-500/30 text-green-400 rounded-lg transition-all text-xs font-bold"
                      >
                        â–¶ ì‹œì‘
                      </button>
                      <button
                        id="timerStopBtn"
                        onclick="stopQuestionTimer()"
                        class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 text-red-400 rounded-lg transition-all text-xs font-bold"
                      >
                        â–  ì •ì§€
                      </button>
                    </div>
                  ` : ''}
                </div>
                <p class="text-lg leading-relaxed text-white font-medium">${question.question}</p>
              </div>

              <!-- Canvas í•„ê¸° ì˜ì—­ -->
              <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-white font-semibold text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    í•„ê¸° ì˜ì—­
                  </h3>
                  <div class="flex gap-2">
                    <button
                      onclick="setPenMode()"
                      id="penBtn"
                      class="text-xs px-3 py-1.5 rounded-lg transition-all font-bold ${!state.isEraserMode ? 'bg-blue-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                    >
                      âœï¸ íœ
                    </button>
                    <button
                      onclick="toggleEraser()"
                      id="eraserBtn"
                      class="text-xs px-3 py-1.5 rounded-lg transition-all font-bold ${state.isEraserMode ? 'bg-orange-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}"
                    >
                      ğŸ§¹ ì§€ìš°ê°œ
                    </button>
                    <button
                      onclick="clearCanvas()"
                      class="text-xs bg-red-500/20 hover:bg-red-500/30 text-red-400 px-3 py-1.5 rounded-lg transition-all font-bold"
                    >
                      ğŸ—‘ï¸ ì „ì²´ ì§€ìš°ê¸°
                    </button>
                  </div>
                </div>

                <canvas
                  id="drawingCanvas"
                  class="w-full bg-white rounded-xl mb-3 touch-none"
                  style="height: 450px; border: 2px solid #374151;"
                ></canvas>

                <div class="flex items-center gap-3 bg-gray-800/50 p-2 rounded-lg">
                  <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-xs">ìƒ‰ìƒ:</span>
                    <div class="flex gap-1">
                      ${['#000000', '#FF0000', '#0000FF', '#00AA00', '#FF6B00'].map(color => `
                        <button
                          onclick="changePenColor('${color}')"
                          class="w-6 h-6 rounded-full border-2 ${state.penColor === color ? 'border-orange-400 ring-2 ring-orange-400/50' : 'border-gray-600'} transition-all"
                          style="background-color: ${color};"
                        ></button>
                      `).join('')}
                    </div>
                  </div>

                  <div class="flex items-center gap-2">
                    <span class="text-gray-400 text-xs">êµµê¸°:</span>
                    <div class="flex gap-1">
                      ${[2, 3, 5, 8].map(size => `
                        <button
                          onclick="changePenSize(${size})"
                          class="w-6 h-6 rounded flex items-center justify-center text-xs ${state.penSize === size ? 'bg-orange-500 text-white' : 'bg-gray-700 text-gray-300'} transition-all"
                        >
                          ${size}
                        </button>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex gap-3 mb-6">
                ${['O', 'X'].map(opt => {
                  let btnClass = 'flex-1 py-4 px-6 rounded-xl font-bold text-2xl transition-all ';

                  if (state.quizCompleted) {
                    // í€´ì¦ˆ ì™„ë£Œ í›„ì—ëŠ” ë²„íŠ¼ ë¹„í™œì„±í™”
                    btnClass += 'cursor-not-allowed opacity-50 ';
                    if (!answer) {
                      btnClass += 'bg-gray-800 border-2 border-gray-700 text-gray-400';
                    } else {
                      if (answer.selected === opt) {
                        if (answer.correct) {
                          btnClass += 'bg-gradient-to-r from-green-500 to-green-600 border-2 border-green-400 text-white';
                        } else {
                          btnClass += 'bg-gradient-to-r from-red-500 to-red-600 border-2 border-red-400 text-white';
                        }
                      } else {
                        btnClass += 'bg-gray-800 border-2 border-gray-700 text-gray-400';
                      }
                    }
                  } else {
                    btnClass += 'transform hover:scale-105 active:scale-95 cursor-pointer ';
                    if (!answer) {
                      btnClass += 'bg-gray-800 hover:bg-gray-700 border-2 border-gray-700 text-white';
                    } else {
                      if (answer.selected === opt) {
                        if (answer.correct) {
                          btnClass += 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 border-2 border-green-400 text-white shadow-lg shadow-green-500/50';
                        } else {
                          btnClass += 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 border-2 border-red-400 text-white shadow-lg shadow-red-500/50';
                        }
                      } else {
                        btnClass += 'bg-gray-800 hover:bg-gray-700 border-2 border-gray-700 text-white';
                      }
                    }
                  }

                  return `
                    <button data-answer="${opt}" class="answer-btn ${btnClass}" ${state.quizCompleted ? 'disabled' : ''}>
                      ${answer?.selected === opt ? (answer.correct ? icon('checkCircle', 'inline mr-2', 22) : icon('xCircle', 'inline mr-2', 22)) : ''}
                      ${opt}
                    </button>
                  `;
                }).join('')}
              </div>
              
              ${answer ? `
                <div class="p-5 rounded-xl border-2 ${answer.correct ? 'bg-green-900/20 border-green-500/50' : 'bg-red-900/20 border-red-500/50'}">
                  <p class="font-bold text-sm mb-2" style="color: ${answer.correct ? '#4ade80' : '#f87171'}">
                    ${answer.correct ? 'âœ“ ì •ë‹µì…ë‹ˆë‹¤!' : 'âœ— ì˜¤ë‹µì…ë‹ˆë‹¤.'}
                  </p>
                ${answer.correct ? `
                  <p class="text-sm text-gray-300 leading-relaxed font-medium">
                    <span class="text-green-400 font-bold">í•´ì„¤:</span> ${question.explanation}
                  </p>
                ` : `
                  <p class="text-sm text-gray-300 leading-relaxed font-medium">
                    <span class="text-orange-400 font-bold">ğŸ’¡ íŒíŠ¸:</span> ${question.hint}
                  </p>
                `}
                  ${state.userType === 'admin' ? `
                    <div class="mt-4 pt-4 border-t border-gray-700">
                      <label class="text-sm text-gray-300 font-bold mb-2 block">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</label>
                      <textarea
                        id="teacherNote-${state.currentQuestion}"
                        class="w-full p-3 bg-gray-900/50 border border-gray-700 rounded-lg text-sm text-gray-300 focus:border-orange-500 focus:outline-none resize-none"
                        rows="3"
                        placeholder="ì´ ë¬¸ì œì— ëŒ€í•œ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                      >${(() => {
                        const noteKey = state.isWrongAnswerTest
                          ? state.currentTheme + '_wrong_' + state.wrongAnswerAttemptId
                          : state.currentTheme;
                        return state.teacherNotes[noteKey]?.[state.currentQuestion] || '';
                      })()}</textarea>
                    </div>
                  ` : ''}
                </div>
              ` : ''}
            </div>

            <div class="flex gap-3">
              <button id="prevBtn" class="flex items-center px-8 py-4 bg-gray-800 hover:bg-gray-700 disabled:bg-gray-800/30 disabled:cursor-not-allowed rounded-xl font-bold transition-all border border-gray-700 disabled:border-gray-800 text-white disabled:text-gray-600 text-base transform hover:scale-105 active:scale-95 disabled:scale-100" ${state.currentQuestion === 0 ? 'disabled' : ''}>
                ${icon('chevronLeft', 'mr-1', 20)}ì´ì „
              </button>

              <button id="nextBtn" class="flex items-center justify-center px-8 py-4 rounded-xl font-bold transition-all text-base transform ${
                state.currentQuestion < questions.length - 1
                  ? 'bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 hover:scale-105 active:scale-95'
                  : 'bg-gray-800/30 cursor-not-allowed border border-gray-700 text-gray-600 scale-100'
              }" ${state.currentQuestion >= questions.length - 1 ? 'disabled' : ''}>
                ë‹¤ìŒ${icon('chevronRight', 'ml-1', 20)}
              </button>

              <button id="finishBtn" class="px-4 py-2 rounded-xl font-bold transition-all text-xs transform ${
                isComplete
                  ? 'bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white shadow-lg shadow-orange-500/30 hover:scale-105 active:scale-95'
                  : 'bg-gray-800/30 cursor-not-allowed border border-gray-700 text-gray-600 scale-100'
              }" ${!isComplete ? 'disabled' : ''}>
                ${isComplete ? `ì™„ë£Œ (${answeredCount}/${questions.length})` : 'ìµœì†Œ 1ë¬¸ì œ ì´ìƒ'}
              </button>
            </div>

            ${isComplete ? `
              <div class="mt-6 border-2 rounded-2xl p-6 shadow-xl ${
                correctCount === answeredCount
                  ? 'bg-green-900/20 border-green-500/50'
                  : 'bg-orange-900/20 border-orange-500/50'
              }">
                <h3 class="text-xl font-bold mb-4 text-center ${
                  correctCount === answeredCount ? 'text-green-400' : 'text-orange-400'
                }">
                  ${correctCount === answeredCount ? 'ğŸ‰ ì™„ë²½í•©ë‹ˆë‹¤!' : 'ì €ì¥ ì¤€ë¹„ ì™„ë£Œ!'}
                </h3>
                <p class="text-base text-center mb-3 text-white font-medium">
                  ì‘ë‹µí•œ ${answeredCount}ë¬¸ì œ ì¤‘ <span class="text-green-400 font-bold">${correctCount}ë¬¸ì œ</span> ë§íˆì…¨ìŠµë‹ˆë‹¤!
                </p>
                <p class="text-sm text-center mb-4 text-gray-300 font-medium">
                  ì •ë‹µë¥ : <span class="font-bold text-lg ${
                    correctCount === answeredCount ? 'text-green-400' : 'text-orange-400'
                  }">
                    ${Math.round((correctCount / answeredCount) * 100)}%
                  </span>
                </p>
                ${answeredCount < theme.questions.length ? `
                  <p class="text-center text-xs text-gray-400 font-medium">
                    ğŸ“ ${theme.questions.length - answeredCount}ê°œ ë¬¸ì œ ë¯¸ì‘ë‹µ (ë¶€ë¶„ ì™„ë£Œë¡œ ì €ì¥ë©ë‹ˆë‹¤)
                  </p>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;

      document.getElementById('backToThemeBtn').addEventListener('click', () => {
        // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ëª¨ë“œ ì¢…ë£Œ
        if (state.isWrongAnswerTest) {
          state.isWrongAnswerTest = false;
          state.wrongAnswerQuestions = [];
          state.wrongAnswerAttemptId = null;
          state.retestRound = null;
          state.showResults = true; // í•™ìŠµ ê¸°ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        }

        state.currentTheme = null;
        state.currentQuestion = 0;
        state.answers = {};
        stopQuestionTimer();
        render();
      });

      // ì´ì „ ë²„íŠ¼ ì´ë²¤íŠ¸
      const prevBtn = document.getElementById('prevBtn');
      if (prevBtn) {
        prevBtn.addEventListener('click', handlePrev);
      }

      // ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸
      const nextBtn = document.getElementById('nextBtn');
      if (nextBtn) {
        nextBtn.addEventListener('click', handleNext);
      }

      // ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸ (í•­ìƒ ë“±ë¡, disabled ì†ì„±ì´ í´ë¦­ ë°©ì§€)
      const finishBtn = document.getElementById('finishBtn');
      if (finishBtn) {
        finishBtn.addEventListener('click', async () => {
          if (!isComplete) return; // ì¶”ê°€ ì•ˆì „ì¥ì¹˜

          console.log('ì™„ë£Œ ë²„íŠ¼ í´ë¦­ë¨');
          finishBtn.disabled = true;
          finishBtn.textContent = 'ì €ì¥ ì¤‘...';
          try {
            await handleFinishQuiz();
          } catch (error) {
            console.error('ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
            finishBtn.disabled = false;
            finishBtn.textContent = 'ê²°ê³¼ ì €ì¥í•˜ê³  ì™„ë£Œ';
          }
        });
      }

      // O, X ë²„íŠ¼ ì´ë²¤íŠ¸ (í€´ì¦ˆ ì™„ë£Œ í›„ì—ëŠ” handleAnswerì—ì„œ ì°¨ë‹¨ë¨)
      document.querySelectorAll('.answer-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          handleAnswer(btn.dataset.answer);
        });
      });

      // Canvas ì´ˆê¸°í™”
      setTimeout(() => {
        initCanvas('drawingCanvas');
        redrawCanvas(); // ê¸°ì¡´ íš ë³µì›
      }, 0);

      // ì„ ìƒë‹˜ ë©”ëª¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê´€ë¦¬ìë§Œ)
      if (state.userType === 'admin' && answer) {
        const teacherNoteTextarea = document.getElementById(`teacherNote-${state.currentQuestion}`);
        if (teacherNoteTextarea) {
          teacherNoteTextarea.addEventListener('input', (e) => {
            // êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ì€ ë³„ë„ì˜ í‚¤ ì‚¬ìš©
            const noteKey = state.isWrongAnswerTest
              ? state.currentTheme + '_wrong_' + state.wrongAnswerAttemptId
              : state.currentTheme;

            if (!state.teacherNotes[noteKey]) {
              state.teacherNotes[noteKey] = {};
            }
            state.teacherNotes[noteKey][state.currentQuestion] = e.target.value;
          });
        }
      }
    }

    function renderResultsScreen(app, currentStudentAttempts) {
      const categoryAttempts = state.recordSelectedCategory 
        ? currentStudentAttempts.filter(a => a.categoryId === state.recordSelectedCategory)
        : [];

      app.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-5xl mx-auto">
            <div class="bg-gray-900 rounded-2xl p-6 mb-6 shadow-xl border border-orange-500/30">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-orange-600 rounded-full flex items-center justify-center mr-3">
                    ${icon('user', 'text-white')}
                  </div>
                  <div>
                    <h2 class="text-xl font-bold text-white">${state.studentName}</h2>
                    <p class="text-sm text-gray-400">í•™ìŠµ ê¸°ë¡</p>
                  </div>
                </div>
                <button id="backBtn" class="px-5 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg font-bold text-white transition-all border border-gray-700 transform hover:scale-105 active:scale-95">
                  ëŒì•„ê°€ê¸°
                </button>
              </div>
            </div>

            ${state.recordSelectedCategory ? `
              <div class="mb-4">
                <button id="allRecordsBtn" class="text-sm text-orange-500 hover:text-orange-400 flex items-center font-semibold">
                  ${icon('chevronLeft', '', 16)}ì±•í„° ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
              </div>
              
              <h3 class="text-lg font-bold text-white mb-4">
                ${categories.find(c => c.id === state.recordSelectedCategory)?.name}
              </h3>

              ${categoryAttempts.length === 0 ? `
                <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                  ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                  <p class="text-gray-400 font-medium">ì´ ì±•í„°ì˜ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
              ` : `
                <div class="space-y-4">
                  ${(() => {
                    // Themeë³„ë¡œ ê·¸ë£¹í™” (themeId ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬)
                    const themeGroups = {};
                    categoryAttempts.forEach(attempt => {
                      const key = attempt.themeId;
                      if (!themeGroups[key]) {
                        themeGroups[key] = [];
                      }
                      themeGroups[key].push(attempt);
                    });

                    // themeId ìˆœì„œëŒ€ë¡œ ì •ë ¬
                    const sortedThemeIds = Object.keys(themeGroups).map(Number).sort((a, b) => a - b);

                    return sortedThemeIds.map(themeId => {
                      const attempts = themeGroups[themeId];
                      const lastAttempt = attempts[attempts.length - 1];
                      const allWrongQuestions = attempts
                        .flatMap(a => a.wrongQuestions || [])
                        .filter((q, idx, arr) => arr.indexOf(q) === idx);

                      const isRetakeAvailable = lastAttempt.percentage < 100;
                      const category = categories.find(c => c.id === lastAttempt.categoryId);
                      const theme = category.chapters.find(t => t.id === lastAttempt.themeId);

                      return `
                        <div class="bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl relative">
                          <div class="flex justify-between items-start mb-4">
                            <div>
                              <h3 class="text-base font-bold text-white mb-1">${lastAttempt.themeName}</h3>
                              <p class="text-xs text-gray-500">ìµœì¢… ì‹œë„: ${lastAttempt.date}</p>
                            </div>
                            <div class="text-right">
                              <div class="text-2xl font-bold ${lastAttempt.percentage === 100 ? 'text-green-400' : 'text-orange-400'}">
                                ${lastAttempt.percentage}%
                              </div>
                              <div class="text-xs text-gray-500 font-semibold">
                                ${lastAttempt.correct} / ${lastAttempt.answeredCount || lastAttempt.total}
                                ${lastAttempt.answeredCount && lastAttempt.answeredCount < lastAttempt.total ?
                                  `<span class="text-blue-400"> (${lastAttempt.answeredCount}ë¬¸ì œ ì‘ë‹µ)</span>` : ''}
                              </div>
                            </div>
                          </div>

                          ${lastAttempt.answeredQuestions && lastAttempt.answeredCount < lastAttempt.total ? `
                            <div class="mb-4 px-4 py-2 bg-blue-900/20 border border-blue-500/30 rounded-xl">
                              <p class="text-xs text-blue-400 font-semibold mb-1">ì‘ë‹µí•œ ë¬¸ì œ:</p>
                              <p class="text-xs text-gray-300">
                                ${lastAttempt.answeredQuestions.map(i => `Q${i+1}`).join(', ')}
                              </p>
                            </div>
                          ` : ''}

                          ${lastAttempt.questionTimes && Object.keys(lastAttempt.questionTimes).length > 0 ? `
                            <div class="mb-4 px-4 py-2 bg-purple-900/20 border border-purple-500/30 rounded-xl">
                              <p class="text-xs text-purple-400 font-semibold mb-2">ë¬¸ì œë³„ ì†Œìš” ì‹œê°„:</p>
                              <div class="grid grid-cols-4 gap-2">
                                ${lastAttempt.answeredQuestions.map(qIdx => {
                                  const timeMs = lastAttempt.questionTimes[qIdx] || 0;
                                  const mins = Math.floor(timeMs / 60000);
                                  const secs = Math.floor((timeMs % 60000) / 1000);
                                  const timeStr = mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}ì´ˆ`;
                                  return `
                                    <div class="text-xs bg-gray-900/50 px-2 py-1 rounded">
                                      <span class="text-gray-400">Q${qIdx+1}:</span>
                                      <span class="text-purple-300 font-semibold ml-1">${timeStr}</span>
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                            </div>
                          ` : ''}

                          <div class="grid grid-cols-4 gap-4 pt-4 border-t border-gray-800 mb-4">
                            <div class="text-center">
                              <div class="text-lg font-bold text-green-400">${lastAttempt.correct}</div>
                              <div class="text-xs text-gray-500">ë§íŒ ê°œìˆ˜</div>
                            </div>
                            <div class="text-center">
                              <div class="text-lg font-bold text-red-400">${(lastAttempt.answeredCount || lastAttempt.total) - lastAttempt.correct}</div>
                              <div class="text-xs text-gray-500">í‹€ë¦° ê°œìˆ˜</div>
                            </div>
                            <div class="text-center">
                              <div class="text-lg font-bold text-blue-400">${attempts.length}</div>
                              <div class="text-xs text-gray-500">ì‹œë„ íšŸìˆ˜</div>
                            </div>
                            <div class="text-center">
                              <div class="text-lg font-bold text-purple-400">${(() => {
                                const totalMs = lastAttempt.totalTime || 0;
                                const mins = Math.floor(totalMs / 60000);
                                const secs = Math.floor((totalMs % 60000) / 1000);
                                return mins > 0 ? `${mins}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;
                              })()}</div>
                              <div class="text-xs text-gray-500">ì†Œìš” ì‹œê°„</div>
                            </div>
                          </div>

                          ${isRetakeAvailable ? `
                            <button 
                              data-category="${lastAttempt.categoryId}" 
                              data-theme="${lastAttempt.themeId}" 
                              class="retake-btn w-full mb-4 px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 rounded-xl font-bold text-white transition-all transform hover:scale-105 active:scale-95 shadow-lg shadow-orange-500/30"
                            >
                              ğŸ”¥ ì¬ì‹œí—˜ ë„ì „í•˜ê¸°
                            </button>
                          ` : `
                            <div class="mb-4 px-6 py-3 bg-green-900/20 border border-green-500/30 rounded-xl text-center">
                              <p class="text-green-400 font-bold text-sm flex items-center justify-center gap-2">
                                ${icon('checkCircle', '', 18)}
                                ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í–ˆìŠµë‹ˆë‹¤!
                              </p>
                            </div>
                          `}

                          ${allWrongQuestions.length > 0 ? `
                            <div class="bg-red-900/20 border border-red-500/30 rounded-xl p-4">
                              <h4 class="text-sm font-bold text-red-400 mb-3 flex items-center flex-wrap gap-2">
                                <span class="flex items-center">
                                  ${icon('xCircle', 'mr-2', 18)}ë³µìŠµ í•„ìš” ë¬¸ì œ
                                </span>
                                ${isRetakeAvailable ? `
                                  <span class="text-xs bg-orange-500/20 text-orange-400 px-2 py-1 rounded font-bold">
                                    ì¬ì‹œí—˜ ì „ ë³µìŠµ!
                                  </span>
                                ` : ''}
                              </h4>
                              <div class="space-y-3">
                                ${allWrongQuestions.map((wrongQ, idx) => {
                                  const questionData = theme.questions.find(q => q.question === wrongQ);
                                  return `
                                    <div class="text-sm bg-gray-900/50 rounded-lg p-3 border border-red-500/20">
                                      <p class="text-red-300 font-medium mb-2 leading-relaxed">â€¢ ${wrongQ}</p>
                                      ${isRetakeAvailable ? `
                                        <p class="text-gray-400 text-xs leading-relaxed">
                                          <span class="text-orange-400 font-bold">ğŸ’¡ íŒíŠ¸:</span> ${questionData?.hint}
                                        </p>
                                      ` : `
                                        <p class="text-gray-400 text-xs leading-relaxed">
                                          <span class="text-green-400 font-bold">í•´ì„¤:</span> ${questionData?.explanation}
                                        </p>
                                      `}
                                    </div>
                                  `;
                                }).join('')}
                              </div>
                              ${isRetakeAvailable ? `
                                <div class="mt-4 p-3 bg-blue-900/20 border border-blue-500/30 rounded-lg text-center">
                                  <p class="text-blue-400 text-xs font-bold">
                                    â„¹ï¸ íŒíŠ¸ í™•ì¸ í›„ ì¬ì‹œí—˜ ë„ì „! ì¬ì‹œí—˜ì—ì„œëŠ” í•´ì„¤ ì œê³µ
                                  </p>
                                </div>
                              ` : ''}

                              <!-- êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ ì•ˆë‚´ ë©”ì‹œì§€ (í•™ìƒì€ ì‹œì‘ ë¶ˆê°€) -->
                              ${hasWrongAnswers && !alreadyHasWrongTest ? `
                                <div class="mt-4 bg-purple-900/20 border border-purple-500/30 rounded-xl p-4">
                                  <p class="text-sm text-purple-400 text-center font-medium">
                                    ğŸ“ êµ¬ë‘í…ŒìŠ¤íŠ¸ ì¬ì‹œí—˜ì€ ì„ ìƒë‹˜ì´ ì‹œì‘í•´ì£¼ì‹¤ ê±°ì˜ˆìš”
                                  </p>
                                </div>
                              ` : ''}
                            </div>
                          ` : ''}

                          <!-- ìƒì„¸ ë¬¸ì œë³„ ê¸°ë¡ (í•„ê¸° ë° ì„ ìƒë‹˜ ë©”ëª¨) - í•­ìƒ í‘œì‹œ -->
                          ${(() => {
                            // ì‘ë‹µí•œ ë¬¸ì œë“¤ë§Œ í‘œì‹œ
                            const answeredQuestions = lastAttempt.answeredQuestions || Object.keys(lastAttempt.answers || {}).map(Number);

                            if (answeredQuestions.length === 0) return '';

                            return `
                              <div class="mt-4 bg-gray-800/30 border border-gray-700 rounded-xl p-4">
                                <h4 class="text-sm font-bold text-blue-400 mb-3 flex items-center">
                                  ${icon('fileText', 'mr-2', 18)}ë¬¸ì œë³„ ìƒì„¸ ê¸°ë¡
                                </h4>
                                <div class="space-y-4">
                                  ${answeredQuestions.map(idx => {
                                    const q = theme.questions[idx];
                                    const answer = lastAttempt.answers?.[idx];
                                    const teacherNote = lastAttempt.teacherNotes?.[idx];

                                    if (!q) return '';

                                    return `
                                      <div class="bg-gray-900/50 rounded-lg p-3 border border-gray-700">
                                        <div class="flex items-center justify-between mb-2">
                                          <p class="text-sm text-gray-300 font-medium">ë¬¸ì œ ${idx + 1}</p>
                                          ${answer ? `
                                            <span class="text-xs font-bold ${answer.correct ? 'text-green-400' : 'text-red-400'}">
                                              ${answer.correct ? 'âœ“ ì •ë‹µ' : 'âœ— ì˜¤ë‹µ'}
                                            </span>
                                          ` : ''}
                                        </div>
                                        <p class="text-xs text-gray-400 mb-3 leading-relaxed">${q.question}</p>

                                        ${answer?.imageUrl ? `
                                          <div class="mb-3">
                                            <p class="text-xs text-blue-400 font-semibold mb-2">âœï¸ í•„ê¸° ë‚´ìš©:</p>
                                            <img src="${answer.imageUrl}" alt="í•„ê¸° ${idx + 1}" class="w-full rounded-lg border border-gray-700" onerror="this.style.display='none';this.previousElementSibling.textContent='í•„ê¸° ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'" />
                                          </div>
                                        ` : ''}

                                        ${teacherNote ? `
                                          <div class="bg-orange-900/20 border border-orange-500/30 rounded p-2">
                                            <p class="text-xs text-orange-400 font-semibold mb-1">ğŸ“ ì„ ìƒë‹˜ ë©”ëª¨:</p>
                                            <p class="text-xs text-gray-300 leading-relaxed">${teacherNote}</p>
                                          </div>
                                        ` : ''}
                                      </div>
                                    `;
                                  }).filter(Boolean).join('')}
                                </div>
                              </div>
                            `;
                          })()}
                        </div>
                      `;
                    }).join('');
                  })()}
                </div>
              `}
            ` : currentStudentAttempts.length === 0 ? `
              <div class="bg-gray-900 rounded-2xl p-12 text-center border border-gray-800">
                ${icon('barChart', 'mx-auto mb-4 text-gray-600', 48)}
                <p class="text-gray-400 font-medium">ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            ` : `
              <div class="grid md:grid-cols-2 gap-4">
                ${categories.filter(cat => currentStudentAttempts.some(a => a.categoryId === cat.id)).map((cat) => {
                  const catAttempts = currentStudentAttempts.filter(a => a.categoryId === cat.id);
                  const avgPercentage = Math.round(catAttempts.reduce((sum, a) => sum + a.percentage, 0) / catAttempts.length);
                  
                  return `
                    <button data-cat="${cat.id}" class="cat-record-btn bg-gray-900 rounded-2xl p-6 border border-gray-800 shadow-xl hover:shadow-orange-500/20 hover:border-orange-500/50 transition-all text-left transform hover:scale-105 active:scale-95">
                      <h3 class="text-base font-bold text-white mb-2">${cat.name}</h3>
                      <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500 font-semibold">í‰ê·  ì •ë‹µë¥ </span>
                        <span class="text-lg font-bold text-orange-400">${avgPercentage}%</span>
                      </div>
                      <div class="text-xs text-gray-500 mt-2 font-medium">
                        ì‹œë„ íšŸìˆ˜: ${catAttempts.length}íšŒ
                      </div>
                    </button>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;

      document.getElementById('backBtn').addEventListener('click', () => {
        state.showResults = false;
        state.recordSelectedCategory = null; // ì´ˆê¸°í™”
        render();
      });

      if (state.recordSelectedCategory) {
        const allRecordsBtn = document.getElementById('allRecordsBtn');
        if (allRecordsBtn) {
          allRecordsBtn.addEventListener('click', () => {
            state.recordSelectedCategory = null;
            render();
          });
        }

        // ì¬ì‹œí—˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelectorAll('.retake-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const categoryId = parseInt(btn.dataset.category);
            const themeId = parseInt(btn.dataset.theme);

            console.log('ğŸ¯ ì¬ì‹œí—˜ ì‹œì‘ - ì¼ë°˜ í…ŒìŠ¤íŠ¸');
            // ì¬ì‹œí—˜ ì‹œì‘
            state.isWrongAnswerTest = false; // ì¼ë°˜ í…ŒìŠ¤íŠ¸ì„ì„ ëª…ì‹œ
            state.wrongAnswerQuestions = [];
            state.wrongAnswerAttemptId = null;
            state.retestRound = null;

            state.showResults = false;
            state.selectedCategory = categoryId;
            state.currentTheme = themeId;
            state.currentQuestion = 0;
            state.answers = {};
            render();
          });
        });
      } else {
        document.querySelectorAll('.cat-record-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            state.recordSelectedCategory = parseInt(btn.dataset.cat);
            render();
          });
        });
      }
    }

    // ì˜¨ë¼ì¸/ì˜¤í”„ë¼ì¸ ì´ë²¤íŠ¸
    window.addEventListener('online', async () => {
      console.log('ì˜¨ë¼ì¸ ë³µêµ¬ë¨! ë™ê¸°í™” ì‹œì‘...');
      await syncPendingData();
    });

    window.addEventListener('offline', () => {
      console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ');
      alert('ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ë°ì´í„°ëŠ” ë¡œì»¬ì— ì €ì¥ë˜ë©° ì˜¨ë¼ì¸ ë³µêµ¬ ì‹œ ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.');
    });

    // íƒ€ì´ë¨¸ ì‹œì‘
    setInterval(() => {
      state.currentTime = Date.now();
      
      document.querySelectorAll('[data-lock-timer]').forEach(element => {
        const themeId = parseInt(element.getAttribute('data-lock-timer'));
        if (isLocked(state.selectedCategory, themeId)) {
          const remainingSeconds = getRemainingTime(state.selectedCategory, themeId);
          const minutes = Math.floor(remainingSeconds / 60);
          const seconds = remainingSeconds % 60;
          element.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} í›„ ì¬ì‹œí—˜ ê°€ëŠ¥`;
        } else {
          render();
        }
      });
    }, 1000);

    // ì•± ì´ˆê¸°í™”
    (async function initApp() {
      await initIndexedDB();
      
      const autoLoginInfo = checkAutoLogin();
      if (autoLoginInfo) {
        console.log('ìë™ ë¡œê·¸ì¸ ì‹¤í–‰:', autoLoginInfo.type);
        
        if (autoLoginInfo.type === 'student') {
          // í•™ìƒ ìë™ ë¡œê·¸ì¸
          state.loading = true;
          render();
          
          try {
            const p = state.phone.replace(/[^0-9]/g, '');
            const id = `${state.studentName.trim()}_${p}`;
            state.uid = id;
            
            await loadData(id);
            
            // í‡´ì›ìƒ ì²´í¬
            const studentData = state.allStudentData[state.studentName];
            if (studentData && studentData.status === 'withdrawn') {
              state.loading = false;
              alert('í‡´ì› ì²˜ë¦¬ëœ í•™ìƒì€ ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹´ë‹¹ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
              logout();
              return;
            }
            
            state.isLoggedIn = true;
            state.userType = 'student';
            state.loading = false;
            render();
          } catch (error) {
            console.error('í•™ìƒ ìë™ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            state.loading = false;
            alert('ìë™ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            logout();
          }
        } else if (autoLoginInfo.type === 'admin') {
          // ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸
          state.loading = true;
          render();
          
          try {
            await loadAdminStudents(autoLoginInfo.name);
            state.isLoggedIn = true;
            state.userType = 'admin';
            state.loading = false;
            render();
          } catch (error) {
            console.error('ê´€ë¦¬ì ìë™ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            state.loading = false;
            alert('ìë™ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            logout();
          }
        }
      } else {
        render();
      }
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
          });
      }
    })();
  </script>
</body>
</html>
